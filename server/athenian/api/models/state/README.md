# Alembic migrations

Generic single-database configuration.

You need to have `alembic.ini`. The easiest way to generate it is to run

```
python3 -m athenian.api.models.state postgresql://user:password@host:port/database
```

Replace `postgresql://user:password@host:port/database` with the actual DB connection string in
[SQLAlchemy format](https://docs.sqlalchemy.org/en/13/core/engines.html).

It is possible to define `OFFLINE` environment variable (to any non-empty value) so that
the SQL operations dump is written to the standard output while the actual DB stays untouched.
You still need to specify the DB connection string though.

### Upgrading DB to the most recent schema version

```
alembic upgrade head
```

### Generating a new migration

```
alembic revision [--autogenerate] -m "Description of the migration"
```

The autogenerated migration may not detect certain changes as explained in the [documentation](https://alembic.sqlalchemy.org/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect). It is always necessary to review and eventualy correct and integrate the candidate migration by hand. Note: you need to have
[`black` installed](https://github.com/psf/black).
