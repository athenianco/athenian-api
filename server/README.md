# OpenAPI generated server

## Overview
This server was generated by the [OpenAPI Generator](https://openapi-generator.tech) project. By using the
[OpenAPI-Spec](https://openapis.org) from a remote server, the server stub was generated driven by
the [Connexion](https://github.com/zalando/connexion) library on top of aiohttp.

## Requirements
Python 3.5.2+

## Usage
To run the server, please execute the following from the root directory:

```
pip3 install -r requirements.txt
python3 -m athenian.api --state-db sqlite:// --metadata-db sqlite:// --ui
```

You may replace `sqlite://` (in-memory zero-configuration sample DB stub) with a real
[SQLAlchemy connection string](https://docs.sqlalchemy.org/en/13/core/engines.html).

and open your browser to here:

```
http://localhost:8080/v1/ui/
```

Your OpenAPI definition lives here:

```
http://localhost:8080/v1/openapi.json
```

To launch the integration tests, use pytest:
```
sudo pip install -r test-requirements.txt
pytest
```

## Operations

[Deployment.](DEPLOYMENT.md)

[DB migration.](server/athenian/api/models/state/README.md)

Prometheus monitoring: `http://localhost:8080/status`.

Generating admin invitations:

```
ATHENIAN_INVITATION_KEY=secret python3 -m athenian.api.invite_admin sqlite://
```

Replace `sqlite://` with the actual DB endpoint and `secret` with the actual passphrase.

Running with real Cloud SQL databases:

```
cloud_sql_proxy -instances=athenian-1:us-east1:owl-cloud-sql-2f803bb6=tcp:5432

--metadata-db=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/api
--state-db=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/state
```

## Development

Install the linters:

```
pip install -r lint-requirements.txt
```

Validate your changes:

```
cd server
flake8
```

Generate sample SQLite metadata and state databases:

```
docker run --rm -e DB_DIR=/io -v$(pwd):/io --entrypoint python3 athenian/api /server/tests/gen_sqlite_db.py
``` 

You should have two SQLite files in `$(pwd)`: `mdb.sqlite` and `sdb.sqlite`.

Obtain Auth0 credentials for running locally: TODO.

## Running the API server locally

Alternatively, you can locally build and run the docker image:

```
# Build the API image
make docker-build

# Run the API container
make run-api
```

And open http://localhost:8080/v1/ui


## Configure Sentry

You can set `SENTRY_PROJECT` and `SENTRY_KEY` environment variables to automatically send the local server crashes to Sentry.

If you're running the API with docker (using `make run-api` from above), you should stop the server, add the Sentry values into the `.env` file that will be in the root folder of `athenian-api`, and start the server again (with `make run-api`).


## Prevent file overriding

After the first generation, add edited files to _.openapi-generator-ignore_ to prevent generator to overwrite them. Typically:
```
server/controllers/*
test/*
*.txt
```
