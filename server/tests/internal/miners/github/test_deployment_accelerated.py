import numpy as np

from athenian.api.internal.miners.github.deployment_accelerated import split_prs_to_jira_ids


def test_split_prs_to_jira_ids_smoke():
    pr_node_ids = np.empty(2, dtype=object)
    pr_node_ids[0] = np.array([1, 2], dtype=int)
    pr_node_ids[1] = np.array([3, 4, 5, 6], dtype=int)
    pr_offsets = np.empty(2, dtype=object)
    pr_offsets[0] = np.array([], dtype=np.uint32)
    pr_offsets[1] = np.array([3], dtype=np.uint32)
    map_prs = np.array([1, 1, 2, 4, 6, 6, 6], dtype=int)
    map_jira = np.array(
        ["DEV-1", "DEV-2", "DEV-3", "DEV-3", "DEV-4", "DEV-3", "DEV-X"], dtype=object,
    )
    by_repo, repo_offs, by_pr, pr_offs = split_prs_to_jira_ids(
        pr_node_ids, pr_offsets, map_prs, map_jira,
    )
    assert by_repo.dtype == object, by_repo
    assert by_pr.dtype == object, by_pr
    assert repo_offs.dtype == object, by_repo
    assert pr_offs.dtype == object, by_pr
    assert len(by_repo) == len(by_pr) == len(repo_offs) == len(pr_offs) == 2
    objarr = np.empty(2, dtype=object)
    objarr[0] = np.array(["DEV-1", "DEV-2"], dtype=object)
    objarr[1] = np.array(["DEV-3"], dtype=object)
    assert str(np.array(np.split(by_pr[0], pr_offs[0]), dtype=object)) == str(objarr)
    objarr = np.empty(4, dtype=object)
    objarr[0] = objarr[2] = np.array([], dtype=object)
    objarr[1] = np.array(["DEV-3"], dtype=object)
    objarr[3] = np.array(["DEV-4", "DEV-3", "DEV-X"], dtype=object)
    assert str(np.array(np.split(by_pr[1], pr_offs[1]), dtype=object)) == str(objarr)

    objarr = np.empty(1, dtype=object)
    objarr[0] = np.array(["DEV-1", "DEV-2", "DEV-3"], dtype=object)
    assert str(np.split(by_repo[0], repo_offs[0])) == str(objarr).replace("\n", ",")
    objarr = np.empty(2, dtype=object)
    objarr[0] = np.array(["DEV-3"], dtype=object)
    objarr[1] = np.array(["DEV-3", "DEV-4", "DEV-X"], dtype=object)
    assert str(np.split(by_repo[1], repo_offs[1])) == str(objarr).replace("\n", ",")


def test_split_prs_to_jira_ids_empty():
    pr_node_ids = np.array([], dtype=object)
    pr_offsets = np.array([], dtype=object)
    map_prs = np.array([1, 1, 2, 4, 6, 6, 6], dtype=int)
    map_jira = np.array(
        ["DEV-1", "DEV-2", "DEV-3", "DEV-3", "DEV-4", "DEV-3", "DEV-X"], dtype=object,
    )
    by_repo, repo_offs, by_pr, pr_offs = split_prs_to_jira_ids(
        pr_node_ids, pr_offsets, map_prs, map_jira,
    )
    assert len(by_repo) == 0
    assert len(repo_offs) == 0
    assert len(by_pr) == 0
    assert len(pr_offs) == 0


def test_split_prs_to_jira_ids_legacy():
    array = np.array
    uint32 = np.uint32
    prs_offsets = array(
        [
            array([3, 3, 3], dtype=uint32),
            array([3, 3, 3], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([3, 3, 3], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([2, 2, 2], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 7], dtype=uint32),
            array([], dtype=uint32),
            array([1, 1, 1], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([2, 2, 2], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([5, 5, 5], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 0], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 4], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([2, 2, 2], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 4], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([1, 1, 1], dtype=uint32),
            array([], dtype=uint32),
            array([10, 10, 10], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 3], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([3, 3, 3], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 3], dtype=uint32),
            array([], dtype=uint32),
            array([3, 3, 3], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([2, 2, 2], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 6], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([3, 3, 3], dtype=uint32),
            array([0, 0, 5], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([9, 9, 9], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([1, 1, 1], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 4], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([2, 2, 2], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([1, 1, 1], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([1, 1, 1], dtype=uint32),
            array([], dtype=uint32),
            array([2, 2, 2], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([4, 4, 4], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 10], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([10, 10, 10], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([4, 4, 4], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([2, 2, 2], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([2, 2, 2], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 12], dtype=uint32),
            array([3, 3, 3], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([1, 1, 1], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([2, 2, 2], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([4, 4, 4], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([10, 10, 10], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([1, 1, 1], dtype=uint32),
            array([], dtype=uint32),
            array([0, 0, 0], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([5, 5, 5], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([4, 4, 4], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([11, 11, 11], dtype=uint32),
            array([11, 11, 11], dtype=uint32),
            array([0, 0, 13], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([6, 6, 6], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([1, 1, 1], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([9, 9, 9], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
            array([], dtype=uint32),
        ],
        dtype=object,
    )
    prs = array(
        [
            array(
                [40338004, 40338577, 40339865, 40317429, 40339416, 40331815, 40339579, 40337542],
            ),
            array([40339865, 40338577, 40338004]),
            array([40339865]),
            array([40339579, 40337542]),
            array([40331815, 40317429, 40339416]),
            array([40338283, 40336674, 40336177]),
            array([40338283, 40336674, 40336177]),
            array([40338036, 40333629, 40338418]),
            array([40338283, 40336674, 40336177]),
            array([40338577, 40338004]),
            array([40338283, 40336674, 40336177]),
            array([40334046, 40333396]),
            array([40338418]),
            array([40338283]),
            array([40338036]),
            array([40337420]),
            array([40333629]),
            array([40335220]),
            array([40336607, 40335875]),
            array([40336607, 40335875]),
            array([40336803]),
            array([40336674]),
            array([40336177]),
            array([40335875]),
            array([40335799]),
            array([40331914, 40331159, 40334774, 40333515, 40332810, 40333118, 40333328]),
            array([40333118]),
            array([40335421]),
            array([40335421]),
            array([40334774]),
            array([40334046]),
            array([40333939, 40334306]),
            array([40334306]),
            array([40333515]),
            array([40333939]),
            array([40333822, 40331662, 40333147, 40332460, 40332018]),
            array([40333822]),
            array([40333328]),
            array([40333549, 40308236, 40305722, 40307015]),
            array([40333549]),
            array([40333396]),
            array([40333147]),
            array([40332810]),
            array([40331914]),
            array([40332460]),
            array([40331159]),
            array([40328398, 40332295, 40330500, 40329776]),
            array([40332295]),
            array([40330500]),
            array([40332018]),
            array([40331662]),
            array([40329776]),
            array([40330137, 40330024]),
            array([40328398]),
            array([40330024]),
            array([40330137]),
            array([40323765, 40329401, 40322666]),
            array([40322666]),
            array([40326855, 40329586, 40327928, 40328864]),
            array([40327928]),
            array([40329401]),
            array([40329586]),
            array([40328864]),
            array([40329361]),
            array([40329361]),
            array(
                [
                    40327036,
                    40327121,
                    40326970,
                    40326935,
                    40327001,
                    40326209,
                    40327029,
                    40326880,
                    40327975,
                    40327094,
                ],
            ),
            array([40327121, 40327094, 40327001, 40327975]),
            array([40326855]),
            array([40326466, 40325099, 40326030]),
            array([40327029, 40327036, 40326880, 40326935, 40326970]),
            array([40320321, 40311336, 40291907]),
            array([40326030]),
            array([40325099, 40326466]),
            array([40326209]),
            array([40325212, 40325135, 40324874]),
            array([40325212, 40325135]),
            array([40324874]),
            array([40322183, 40324604, 40323747]),
            array([40324604]),
            array([40323250, 40323698, 40323367]),
            array([40322183]),
            array([40324467]),
            array([40323747]),
            array([40323765]),
            array([40323698]),
            array([40321166, 40322936]),
            array([40323367]),
            array([40323250]),
            array([40322936]),
            array([40321166]),
            array([40320654, 40319209, 40321038, 40321094, 40321812, 40319794]),
            array([40321094]),
            array([40321038]),
            array([40321812]),
            array([40319794]),
            array([40321296]),
            array([40320654]),
            array([40320321]),
            array([40291907]),
            array([40319209]),
            array([40318309, 40317207, 40318723]),
            array([40315103, 40314155, 40314668, 40315386, 40316692]),
            array([40315386]),
            array([40318723]),
            array([40311336]),
            array([40316692]),
            array([40318309]),
            array([40317207]),
            array(
                [
                    40315794,
                    40315891,
                    40315718,
                    40315734,
                    40315635,
                    40317176,
                    40315685,
                    40315805,
                    40315714,
                ],
            ),
            array([40317176]),
            array(
                [40315805, 40315734, 40315891, 40315635, 40315685, 40315714, 40315794, 40315718],
            ),
            array(
                [
                    40293894,
                    40303148,
                    40288197,
                    40261476,
                    40297183,
                    40309025,
                    40262866,
                    40283789,
                    40279760,
                    40287845,
                ],
            ),
            array([40314155]),
            array([40315103]),
            array([40314668]),
            array([40314563]),
            array([40314563]),
            array([40312126, 40309480, 40311177, 40314362]),
            array([40314362]),
            array([40311177]),
            array([40313042, 40313461]),
            array([40313461]),
            array([40313042]),
            array([40310436]),
            array([40312796]),
            array([40312126]),
            array([40310436]),
            array([40312474]),
            array([40312161]),
            array([40312161]),
            array([40311581, 40311785]),
            array([40311785]),
            array([40311581]),
            array([40309480]),
            array([40310400]),
            array([40310023, 40306418, 40306446, 40305597]),
            array([40310023]),
            array([40309515]),
            array([40297183, 40303148, 40309025, 40293894, 40309149, 40287845]),
            array([40309025]),
            array([40309025]),
            array(
                [
                    40306164,
                    40306748,
                    40303512,
                    40305305,
                    40306196,
                    40303723,
                    40294350,
                    40306930,
                    40304986,
                    40302577,
                ],
            ),
            array([40306446, 40305597, 40306418]),
            array([40306196]),
            array(
                [
                    40307179,
                    40305809,
                    40306292,
                    40306386,
                    40306357,
                    40306474,
                    40305396,
                    40306516,
                    40307149,
                    40306333,
                ],
            ),
            array([40306516, 40306357, 40306333, 40307149]),
            array([40308236]),
            array([40307179, 40306474, 40306386, 40306292]),
            array([40303512]),
            array([40307015, 40305722]),
            array([40306930]),
            array([40306748]),
            array([40306164]),
            array([40305809]),
            array([40305809]),
            array([40305305]),
            array([40305396]),
            array([40304986]),
            array([40302951, 40301229, 40302020, 40303571]),
            array([40302951]),
            array([40303571, 40302020, 40301229]),
            array([40303723]),
            array([40304317]),
            array([40302418, 40304118]),
            array([40304118]),
            array([40302577]),
            array([40302418]),
            array([40294350]),
            array([40303148]),
            array([40302620, 40300860]),
            array([40302620]),
            array([40300860]),
            array(
                [
                    40298984,
                    40286969,
                    40298486,
                    40300005,
                    40299460,
                    40300989,
                    40294810,
                    40298571,
                    40293614,
                    40299099,
                    40296617,
                    40296293,
                ],
            ),
            array([40300670, 40300823, 40300571]),
            array([40300823]),
            array([40299460]),
            array([40300989]),
            array([40300005, 40298984, 40299099]),
            array([40300670]),
            array([40300571]),
            array([40300048]),
            array([40297183]),
            array([40300048]),
            array([40299686, 40299760]),
            array([40299760]),
            array([40299686]),
            array([40299488, 40299203, 40296554, 40298860]),
            array([40299488, 40296554]),
            array([40298860, 40299203]),
            array([40298571]),
            array([40298486]),
            array(
                [
                    40296443,
                    40296005,
                    40295957,
                    40298128,
                    40296964,
                    40296064,
                    40294992,
                    40297416,
                    40295960,
                    40297074,
                ],
            ),
            array([40296617]),
            array([40296293]),
            array([40298128]),
            array([40297416]),
            array([40296005, 40297074, 40296064]),
            array([40296964]),
            array([40295957, 40296443, 40294992, 40295960]),
            array([40294810]),
            array([40292102]),
            array([40295703]),
            array([40294124, 40294484]),
            array([40286969]),
            array([40292102]),
            array([40294124, 40294484]),
            array([40293614]),
            array([40293894]),
            array(
                [40293054, 40291733, 40292662, 40291830, 40293126, 40288600, 40286408, 40291418],
            ),
            array([40293240]),
            array([40293054, 40293126]),
            array([40291733]),
            array([40292662]),
            array([40291830]),
            array([40287845]),
            array([40291236, 40290428, 40291527, 40291074]),
            array([40291527]),
            array([40291418]),
            array([40291236]),
            array([40290428, 40291074]),
            array(
                [
                    40287265,
                    40287791,
                    40289439,
                    40287613,
                    40287434,
                    40287589,
                    40287474,
                    40287469,
                    40287500,
                    40287411,
                    40287465,
                    40287917,
                ],
            ),
            array(
                [
                    40287791,
                    40287474,
                    40287465,
                    40287265,
                    40287469,
                    40287589,
                    40287613,
                    40287411,
                    40287434,
                    40287500,
                    40289439,
                ],
            ),
            array(
                [
                    40278540,
                    40281871,
                    40278733,
                    40284498,
                    40278134,
                    40284614,
                    40290172,
                    40283945,
                    40281815,
                    40286803,
                    40282497,
                    40283741,
                    40281299,
                ],
            ),
            array([40290172]),
            array([40287791]),
            array([40287474, 40287465, 40289439]),
            array([40289494, 40288197]),
            array([40288197]),
            array([40287411, 40287265, 40287500, 40287613, 40287434, 40287589, 40287469]),
            array([40288600, 40286408]),
            array([40287917]),
            array([40286803]),
            array(
                [
                    40286057,
                    40283870,
                    40286136,
                    40284072,
                    40277978,
                    40283251,
                    40282905,
                    40280014,
                    40277718,
                    40261705,
                    40285995,
                    40262189,
                    40267980,
                    40284751,
                    40274748,
                ],
            ),
            array([40286057]),
            array([40283870, 40284072, 40286136, 40277978]),
            array([40285995]),
            array([40283870]),
            array([40262866, 40261476, 40285202, 40258619, 40258191, 40283789, 40279760]),
            array([40277718, 40274748, 40284751, 40267980, 40262189, 40282905, 40280014]),
            array([40284614]),
            array([40284498]),
            array([40283945]),
            array([40283741]),
            array([40283789]),
            array([40282497]),
            array([40283251]),
            array([40281731]),
            array([40281815]),
            array([40281871]),
            array([40281731]),
            array(
                [
                    40278919,
                    40278225,
                    40278222,
                    40278316,
                    40278289,
                    40277422,
                    40278084,
                    40278171,
                    40278194,
                ],
            ),
            array([40278919]),
            array([40278733]),
            array([40281299]),
        ],
        dtype=object,
    )
    map_prs = np.concatenate(prs)
    np.random.seed(777)
    map_prs = np.repeat(map_prs, np.random.randint(0, 4, len(map_prs)))
    np.random.shuffle(map_prs)
    randints = np.random.randint(1, len(map_prs) + 1, len(map_prs))
    map_jira = np.array([f"DEV-{i}" for i in randints], dtype=object)
    by_repo, repo_offs, by_pr, pr_offs = split_prs_to_jira_ids(prs, prs_offsets, map_prs, map_jira)
    assert len(by_repo) == len(prs)
    nonempty = 0
    checked_issues = 0
    unique_issues = set()
    for arr, offs in zip(by_repo, repo_offs):
        assert arr.dtype == object
        for issues in np.split(arr, offs):
            if len(issues):
                nonempty += 1
            for name in issues:
                checked_issues += 1
                unique_issues.add(name)
                assert name.startswith("DEV-")
    assert nonempty == 242
    assert checked_issues == 1848
    assert unique_issues == set(map_jira)
    assert len(by_pr) == len(prs)

    unique_issues = set()
    nonempty = 0
    for origin_prs, dep, offs in zip(prs, by_pr, pr_offs):
        assert len(origin_prs) == len(offs) + 1
        if len(dep):
            nonempty += 1
        for issues in np.split(dep, offs):
            unique_issues.update(issues)
    assert nonempty == 238
    assert unique_issues == set(map_jira)
