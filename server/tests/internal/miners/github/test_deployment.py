from datetime import datetime, timedelta, timezone
from functools import partial
from pathlib import Path
import pickle
from typing import Any

import medvedi as md
from medvedi.testing import assert_frame_equal, assert_index_equal
import morcilla
import numpy as np
from numpy.testing import assert_array_equal
import pytest
import sqlalchemy as sa
from sqlalchemy import delete, func, insert, select

from athenian.api.async_utils import gather
from athenian.api.defer import wait_deferred, with_defer
from athenian.api.internal.account import get_metadata_account_ids
from athenian.api.internal.jira import JIRAConfig
from athenian.api.internal.miners.filters import JIRAFilter, LabelFilter
from athenian.api.internal.miners.github.dag_accelerated import (
    extract_independent_ownership,
    extract_pr_commits,
)
from athenian.api.internal.miners.github.deployment import (
    MineDeploymentsMetrics,
    deployment_facts_extract_mentioned_people,
    hide_outlier_first_deployments,
    mine_deployments,
    reset_broken_deployments,
)
from athenian.api.internal.miners.github.release_mine import mine_releases, mine_releases_by_name
from athenian.api.internal.miners.types import (
    DeployedComponent as DeployedComponentStruct,
    Deployment,
    DeploymentConclusion,
    DeploymentFacts,
    ReleaseFacts,
)
from athenian.api.internal.settings import LogicalRepositorySettings
from athenian.api.models.metadata.github import Release
from athenian.api.models.persistentdata.models import (
    DeployedComponent,
    DeployedLabel,
    DeploymentNotification,
    ReleaseNotification,
)
from athenian.api.models.precomputed.models import (
    GitHubCommitDeployment,
    GitHubDeploymentFacts,
    GitHubPullRequestDeployment,
    GitHubReleaseDeployment,
)
from tests.conftest import get_default_branches, get_release_match_setting_tag
from tests.testutils.db import assert_existing_row, assert_missing_row, count, models_insert
from tests.testutils.factory.common import DEFAULT_MD_ACCOUNT_ID
from tests.testutils.factory.persistentdata import (
    DeployedComponentFactory,
    DeploymentNotificationFactory,
)
from tests.testutils.time import dt


@pytest.mark.parametrize("eager_filter_repositories", [False, True])
@with_defer
async def test_mine_deployments_from_scratch(
    sample_deployments,
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
    eager_filter_repositories,
):
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    metrics = MineDeploymentsMetrics.empty()
    await mine_releases(
        ["src-d/go-git"],
        {},
        branches,
        default_branches,
        time_from,
        time_to,
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        with_avatars=False,
        with_extended_pr_details=False,
        with_deployments=False,
    )
    await wait_deferred()

    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
        metrics=metrics,
        eager_filter_repositories=eager_filter_repositories,
    )
    _validate_deployments(
        deps, 7 if eager_filter_repositories else 9, True, eager_filter_repositories,
    )
    deployment_facts_extract_mentioned_people(deps)
    await wait_deferred()
    commits = await pdb.fetch_all(select(GitHubCommitDeployment))
    assert len(commits) == 4684
    assert metrics.count == 14 if eager_filter_repositories else 18
    assert metrics.unresolved == 0

    # test the cache
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        None,
        None,
        None,
        cache,
        eager_filter_repositories=eager_filter_repositories,
    )
    _validate_deployments(
        deps, 7 if eager_filter_repositories else 9, True, eager_filter_repositories,
    )


@with_defer
async def test_mine_deployments_unresolved(
    sample_deployments,
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
):
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    metrics = MineDeploymentsMetrics.empty()

    await rdb.execute(
        insert(DeploymentNotification).values(
            account_id=1,
            name="whatever",
            conclusion="SUCCESS",
            environment="production",
            started_at=datetime(2019, 11, 2, tzinfo=timezone.utc),
            finished_at=datetime(2019, 11, 2, 0, 10, tzinfo=timezone.utc),
            created_at=datetime.now(timezone.utc),
            updated_at=datetime.now(timezone.utc),
        ),
    )
    await rdb.execute(
        insert(DeployedComponent).values(
            account_id=1,
            deployment_name="whatever",
            repository_node_id=40550,
            reference="not exists",
            created_at=datetime.now(timezone.utc),
        ),
    )

    await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
        eager_filter_repositories=False,
        metrics=metrics,
    )
    assert metrics.count == 18
    assert metrics.unresolved == 1


@with_defer
async def test_mine_deployments_addons_cache(
    sample_deployments,
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
):
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    await mine_releases(
        ["src-d/go-git"],
        {},
        branches,
        default_branches,
        time_from,
        time_to,
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        with_avatars=False,
        with_extended_pr_details=False,
        with_deployments=False,
    )
    await wait_deferred()
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        JIRAConfig(1, {}, {}),
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
        with_extended_prs=True,
        with_jira=True,
        eager_filter_repositories=False,
    )
    _validate_deployments(deps, 9, True, False)
    deployment_facts_extract_mentioned_people(deps)
    await wait_deferred()

    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        JIRAConfig(1, {}, {}),
        (6366825,),
        None,
        None,
        None,
        cache,
        eager_filter_repositories=False,
    )
    _validate_deployments(deps, 9, True, False)


@with_defer
async def test_mine_deployments_middle(
    sample_deployments,
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
):
    time_from = datetime(2017, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    await mine_releases(
        ["src-d/go-git"],
        {},
        branches,
        default_branches,
        datetime(2016, 1, 1, tzinfo=timezone.utc),
        time_to,
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        with_avatars=False,
        with_extended_pr_details=False,
        with_deployments=False,
    )
    await wait_deferred()
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
        eager_filter_repositories=False,
    )
    _validate_deployments(deps, 7, False, False)
    deployment_facts_extract_mentioned_people(deps)


@with_defer
async def test_mine_deployments_append(
    sample_deployments,
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
):
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2019, 11, 2, tzinfo=timezone.utc)
    await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
        eager_filter_repositories=False,
    )
    await wait_deferred()
    name = "%s_%d_%02d_%02d" % ("production", 2019, 11, 2)
    await rdb.execute(
        insert(DeploymentNotification).values(
            account_id=1,
            name=name,
            conclusion="SUCCESS",
            environment="production",
            started_at=datetime(2019, 11, 2, tzinfo=timezone.utc),
            finished_at=datetime(2019, 11, 2, 0, 10, tzinfo=timezone.utc),
            created_at=datetime.now(timezone.utc),
            updated_at=datetime.now(timezone.utc),
        ),
    )
    await rdb.execute(
        insert(DeployedComponent).values(
            account_id=1,
            deployment_name=name,
            repository_node_id=40550,
            reference="v4.13.1",
            resolved_commit_node_id=2755244,
            created_at=datetime.now(timezone.utc),
        ),
    )
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to + timedelta(days=1),
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
        eager_filter_repositories=False,
    )
    await wait_deferred()
    i = np.argmax(deps.index.get_level_values(0) == name)
    assert len(deps["prs"][i]) == 0
    assert len(deps["releases"][i]) == 0
    await _validate_deployed_prs(pdb)


@with_defer
async def test_mine_deployments_insert_middle(
    sample_deployments,
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
):
    time_from = datetime(2018, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2018, 12, 31, tzinfo=timezone.utc)
    await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
    )
    await wait_deferred()
    time_from = datetime(2015, 12, 31, tzinfo=timezone.utc)
    time_to = datetime(2019, 12, 31, tzinfo=timezone.utc)
    await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
    )
    await wait_deferred()
    await _validate_deployed_prs(pdb)


@with_defer
async def test_mine_deployments_only_failed(
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
):
    await rdb.execute(delete(DeployedLabel))
    await rdb.execute(delete(DeployedComponent))
    await rdb.execute(delete(DeploymentNotification))
    for year, month, day, conclusion, tag, commit in ((2018, 1, 10, "FAILURE", "4.0.0", 2757510),):
        name = "production_%d_%02d_%02d" % (year, month, day)
        await rdb.execute(
            insert(DeploymentNotification).values(
                account_id=1,
                name=name,
                conclusion=conclusion,
                environment="production",
                started_at=datetime(year, month, day, tzinfo=timezone.utc),
                finished_at=datetime(year, month, day, 0, 10, tzinfo=timezone.utc),
                created_at=datetime.now(timezone.utc),
                updated_at=datetime.now(timezone.utc),
            ),
        )
        await rdb.execute(
            insert(DeployedComponent).values(
                account_id=1,
                deployment_name=name,
                repository_node_id=40550,
                reference=tag,
                resolved_commit_node_id=commit,
                created_at=datetime.now(timezone.utc),
            ),
        )
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2019, 11, 2, tzinfo=timezone.utc)
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
    )
    await wait_deferred()
    assert len(deps) == 1
    assert len(deps.iloc[0]["prs"]) == 340
    rows = await pdb.fetch_all(select(GitHubPullRequestDeployment))
    assert len(rows) == 340


@pytest.mark.parametrize("eager_filter_repositories", [False, True])
@with_defer
async def test_mine_deployments_logical(
    sample_deployments,
    release_match_setting_tag_logical,
    branches,
    default_branches,
    prefixer,
    logical_settings_full,
    mdb,
    pdb,
    rdb,
    cache,
    eager_filter_repositories,
):
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    await mine_releases(
        ["src-d/go-git/alpha", "src-d/go-git/beta", "src-d/go-git"],
        {},
        branches,
        default_branches,
        time_from,
        time_to,
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_logical,
        logical_settings_full,
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        with_avatars=False,
        with_extended_pr_details=False,
        with_deployments=False,
    )
    await wait_deferred()
    deps = await mine_deployments(
        ["src-d/go-git/alpha"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_logical,
        logical_settings_full,
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
        eager_filter_repositories=eager_filter_repositories,
    )
    assert len(deps) == 6 if eager_filter_repositories else 18
    physical_count = alpha_count = beta_count = beta_releases = 0
    for deployment_name, components, releases in zip(
        deps.index.values,
        deps["components"],
        deps["releases"],
    ):
        component_repos = components.unique(DeployedComponent.repository_full_name)
        release_repos = (
            np.unique(releases.index.get_level_values(1))
            if not releases.empty
            else np.array([], dtype=object)
        )
        has_logical = False
        if "2016" in deployment_name or "2019" in deployment_name:
            has_logical = True
            alpha_count += 1
            assert "src-d/go-git/alpha" in component_repos, deployment_name
            assert "src-d/go-git" not in component_repos, deployment_name
            assert "src-d/go-git/alpha" in release_repos, deployment_name
            assert "src-d/go-git" not in release_repos, deployment_name
        if "prod" in deployment_name or "2019" in deployment_name:
            has_logical = True
            beta_count += 1
            assert "src-d/go-git/beta" in component_repos, deployment_name
            assert "src-d/go-git" not in component_repos, deployment_name
            beta_releases += "src-d/go-git/beta" in release_repos
            assert "src-d/go-git" not in release_repos, deployment_name
        if not has_logical:
            physical_count += 1
            assert component_repos.tolist() == ["src-d/go-git"]
            assert release_repos.tolist() in ([], ["src-d/go-git"])

    assert alpha_count == 6
    assert beta_count == 4 if eager_filter_repositories else 10
    assert physical_count == 0 if eager_filter_repositories else 6
    assert beta_releases == 2 if eager_filter_repositories else 6


@with_defer
async def test_mine_deployments_no_prs(
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
):
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2016, 1, 1, tzinfo=timezone.utc)
    await rdb.execute(delete(DeployedLabel))
    await rdb.execute(delete(DeployedComponent))
    await rdb.execute(delete(DeploymentNotification))
    await rdb.execute(
        insert(DeploymentNotification).values(
            account_id=1,
            name="DeployWithoutPRs",
            conclusion="SUCCESS",
            environment="production",
            started_at=datetime(2015, 5, 21, tzinfo=timezone.utc),
            finished_at=datetime(2015, 5, 21, 0, 10, tzinfo=timezone.utc),
            created_at=datetime.now(timezone.utc),
            updated_at=datetime.now(timezone.utc),
        ),
    )
    await rdb.execute(
        insert(DeployedComponent).values(
            account_id=1,
            deployment_name="DeployWithoutPRs",
            repository_node_id=40550,
            reference="35b585759cbf29f8ec428ef89da20705d59f99ec",
            resolved_commit_node_id=2755715,
            created_at=datetime.now(timezone.utc),
        ),
    )
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
    )
    assert len(deps) == 1
    assert len(deps.iloc[0]["prs"]) == 0


@with_defer
async def test_mine_deployments_no_release_facts(
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
):
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
    )
    assert len(deps) == 1
    assert deps.iloc[0][DeploymentFacts.f.name] == "Dummy deployment"
    deployment_facts_extract_mentioned_people(deps)
    dfs = deps["releases"][0]
    obj = {
        c: {
            (node_id, repo): v if not isinstance(v, np.ndarray) else v.tolist()
            for node_id, repo, v in zip(*dfs.index.levels(), dfs[c])
        }
        for c in dfs.columns
    }
    for col in (
        ReleaseFacts.f.prs_created_at,
        ReleaseFacts.f.node_id,
        ReleaseFacts.f.repository_full_name,
    ):
        del obj[col]

    all_keys = list(obj[ReleaseFacts.f.commit_authors])
    for field in (
        "jira_ids",
        "jira_pr_offsets",
        "jira_priorities",
        "jira_projects",
        "jira_types",
        "jira_labels",
    ):
        assert obj.pop(field) == {k: [] for k in all_keys}

    for field in (ReleaseFacts.f.prs_title, ReleaseFacts.f.deployments):
        assert obj.pop(field) == {k: None for k in all_keys}

    ground_truth = {
        "commit_authors": {
            (41475, "src-d/go-git"): [39789, 40187],
            (41474, "src-d/go-git"): [39771, 39789, 39887, 40025, 40292],
            (41473, "src-d/go-git"): [
                39789,
                39811,
                39828,
                39868,
                39890,
                39974,
                39994,
                40083,
                40114,
                40146,
                40158,
                40187,
                40410,
            ],
            (41472, "src-d/go-git"): [
                39789,
                39849,
                39974,
                40020,
                40138,
                40167,
                40243,
                40298,
                40375,
            ],
            (41471, "src-d/go-git"): [39789, 39926, 40020, 40039, 40374],
            (41470, "src-d/go-git"): [39789, 39849],
            (41469, "src-d/go-git"): [39789, 39828, 39849, 40328],
            (41468, "src-d/go-git"): [39789, 40070],
            (41467, "src-d/go-git"): [
                39789,
                39798,
                39913,
                39926,
                40031,
                40032,
                40044,
                40061,
                40070,
                40228,
                40261,
                40414,
            ],
            (41485, "src-d/go-git"): [
                39764,
                39789,
                39828,
                39849,
                39900,
                39926,
                39968,
                40070,
                40095,
                40181,
                40186,
                40189,
                40374,
                40377,
                40410,
            ],
            (41484, "src-d/go-git"): [39789, 39849, 39863, 40070, 40076, 40197, 40414],
            (41483, "src-d/go-git"): [
                39789,
                39849,
                39900,
                39926,
                39957,
                40165,
                40266,
                40345,
                40414,
            ],
            (41482, "src-d/go-git"): [39789, 39957, 40070, 40135],
            (41481, "src-d/go-git"): [39788, 39789, 39849, 39926, 40135],
            (41480, "src-d/go-git"): [39789, 39804, 39849],
            (41479, "src-d/go-git"): [39789, 39849, 40175, 40374],
            (41478, "src-d/go-git"): [39789, 39845, 40068, 40093],
            (41477, "src-d/go-git"): [39788, 39789, 39804, 39849, 39881, 39896, 39926, 40239],
            (41476, "src-d/go-git"): [39789, 39874, 39881, 40038, 40093, 40287],
            (41517, "src-d/go-git"): [39789, 39814, 39849, 40090, 40283, 40288],
            (41519, "src-d/go-git"): [39789, 39800, 39849],
            (41518, "src-d/go-git"): [
                39789,
                39844,
                39849,
                39926,
                39936,
                39957,
                39962,
                39968,
                39980,
                39989,
                40051,
                40052,
                40059,
                40109,
                40170,
                40175,
                40197,
                40230,
                40239,
                40246,
                40283,
                40293,
                40319,
                40374,
                40392,
            ],
            (41514, "src-d/go-git"): [39789, 39957, 40239],
            (41513, "src-d/go-git"): [
                39789,
                39799,
                39818,
                39949,
                39957,
                40070,
                40123,
                40239,
                40304,
                40374,
            ],
            (41516, "src-d/go-git"): [39789, 39926, 40070, 40239],
            (41515, "src-d/go-git"): [39789, 39891, 39926, 40045, 40070],
            (41512, "src-d/go-git"): [39789, 39926, 40070, 40239, 40317],
            (41511, "src-d/go-git"): [
                39789,
                39800,
                39891,
                39906,
                39926,
                40070,
                40073,
                40093,
                40175,
                40284,
                40385,
                40418,
            ],
            (41510, "src-d/go-git"): [39789],
            (41509, "src-d/go-git"): [39789, 39926, 40096, 40418],
            (41508, "src-d/go-git"): [39789, 39921, 39926, 39957, 40070, 40418],
            (41506, "src-d/go-git"): [40070, 40096],
            (41505, "src-d/go-git"): [39789, 39926, 40070, 40096, 40283, 40418],
            (41503, "src-d/go-git"): [39789, 40070, 40283, 40418],
            (41502, "src-d/go-git"): [39789, 40070, 40303],
            (41501, "src-d/go-git"): [39789, 39926, 40070, 40394, 40418],
            (41507, "src-d/go-git"): [39789, 40020, 40070, 40283, 40418],
            (41496, "src-d/go-git"): [40020, 40418],
            (41495, "src-d/go-git"): [39789, 40020, 40418],
            (41500, "src-d/go-git"): [39789],
            (41499, "src-d/go-git"): [39758, 39789],
            (41498, "src-d/go-git"): [39789],
            (41497, "src-d/go-git"): [39789, 40058],
            (41490, "src-d/go-git"): [39789, 40058],
            (41488, "src-d/go-git"): [39789, 39904, 39957, 40238, 40389, 40418],
            (41487, "src-d/go-git"): [39789, 40418],
            (41486, "src-d/go-git"): [39789, 40418],
            (41494, "src-d/go-git"): [39789, 40418],
            (41493, "src-d/go-git"): [39789, 40418],
            (41492, "src-d/go-git"): [39789, 40274, 40418],
            (41491, "src-d/go-git"): [39789, 40221, 40274, 40310, 40347, 40366],
        },
        "prs_node_id": {
            (41475, "src-d/go-git"): [163398],
            (41474, "src-d/go-git"): [163375, 163377, 163378, 163380, 163395, 163396, 163397],
            (41473, "src-d/go-git"): [
                163341,
                163333,
                163334,
                163356,
                163357,
                163359,
                163360,
                163362,
                163361,
                163363,
                163364,
                163365,
                163366,
                163367,
                163368,
                163369,
                163370,
                163371,
                163346,
                163347,
                163348,
                163351,
                163372,
                163373,
                163374,
            ],
            (41472, "src-d/go-git"): [
                163318,
                163319,
                163320,
                163322,
                163324,
                163325,
                163326,
                163340,
                163342,
                163343,
                163344,
                163332,
                163336,
                163353,
                163354,
            ],
            (41471, "src-d/go-git"): [163287, 163314, 163328, 163329, 163330, 163331],
            (41470, "src-d/go-git"): [163313],
            (41469, "src-d/go-git"): [163255, 163307, 163308, 163309, 163316],
            (41468, "src-d/go-git"): [163312],
            (41467, "src-d/go-git"): [
                163304,
                163306,
                163276,
                163277,
                163278,
                163280,
                163281,
                163282,
                163285,
                163286,
                163289,
                163290,
                163292,
                163293,
                163295,
                163310,
                163311,
            ],
            (41485, "src-d/go-git"): [
                163158,
                163199,
                163200,
                163246,
                163262,
                163273,
                163272,
                163253,
                163254,
                163256,
                163257,
                163259,
                163297,
                163298,
                163299,
                163300,
                163301,
                163302,
                163303,
            ],
            (41484, "src-d/go-git"): [
                163222,
                163247,
                163242,
                163243,
                163245,
                163261,
                163263,
                163264,
                163265,
                163266,
                163268,
                163269,
            ],
            (41483, "src-d/go-git"): [
                163211,
                163223,
                163248,
                163249,
                163250,
                163251,
                163252,
                163233,
                163234,
                163235,
                163236,
                163237,
                163239,
                163240,
                163241,
            ],
            (41482, "src-d/go-git"): [163231, 163232, 163213, 163215, 163216, 163218, 163219],
            (41481, "src-d/go-git"): [163224, 163225, 163226, 163228, 163229, 163230],
            (41480, "src-d/go-git"): [163208, 163198, 163201],
            (41479, "src-d/go-git"): [163167, 163205, 163206, 163207],
            (41478, "src-d/go-git"): [163178, 163202, 163203],
            (41477, "src-d/go-git"): [163175, 163176, 163179, 163182, 163183, 163184, 163185],
            (41476, "src-d/go-git"): [163160, 163187, 163188, 163189, 163190, 163192, 163193],
            (41517, "src-d/go-git"): [
                163174,
                163157,
                163159,
                163161,
                163162,
                163164,
                163165,
                163166,
            ],
            (41519, "src-d/go-git"): [163169, 163170, 163172, 163173],
            (41518, "src-d/go-git"): [
                163027,
                163052,
                163054,
                163055,
                163056,
                163057,
                163058,
                163107,
                163108,
                163109,
                163110,
                163112,
                163096,
                163097,
                163098,
                163100,
                163099,
                163101,
                163103,
                163104,
                163105,
                163106,
                163147,
                163149,
                163150,
                163151,
                163152,
                163153,
                163154,
                163155,
                163156,
                163113,
                163114,
                163115,
                163116,
                163117,
                163118,
                163119,
                163120,
                163121,
                163122,
                163123,
                163124,
                163125,
                163126,
                163127,
                163128,
                163131,
                163132,
                163133,
                163134,
                163135,
                163136,
                163137,
                163138,
                163140,
                163141,
                163142,
                163143,
                163144,
                163146,
                163168,
            ],
            (41514, "src-d/go-git"): [163046, 163048, 163049, 163051, 163053],
            (41513, "src-d/go-git"): [
                163076,
                163090,
                163091,
                163092,
                163093,
                163094,
                163095,
                163028,
                163029,
                163030,
                163031,
                163032,
                163033,
                163034,
                163036,
                163037,
                163038,
                163039,
                163042,
                163043,
                163044,
                163045,
            ],
            (41516, "src-d/go-git"): [
                163063,
                163066,
                163067,
                163068,
                163070,
                163069,
                163072,
                163075,
                163074,
                163080,
                163081,
                163082,
                163083,
                163084,
                163085,
                163086,
                163087,
                163088,
                163089,
            ],
            (41515, "src-d/go-git"): [
                162988,
                162994,
                162996,
                163005,
                163006,
                163007,
                163008,
                163009,
                163010,
                163011,
                163012,
                163013,
                163015,
                163016,
                163059,
                163060,
                163061,
                163062,
                163064,
            ],
            (41512, "src-d/go-git"): [
                162975,
                163023,
                163025,
                163026,
                162989,
                162992,
                162993,
                162995,
                162997,
                162998,
                163000,
                163001,
                163002,
                163003,
            ],
            (41511, "src-d/go-git"): [
                163529,
                162887,
                162888,
                162889,
                162890,
                162892,
                162893,
                162894,
                162895,
                162896,
                162897,
                162898,
                162899,
                162900,
                162901,
                162903,
                162904,
                162905,
                162906,
                162908,
                162910,
                162911,
                162912,
                162913,
                162914,
                162915,
                162916,
                162918,
                162919,
                162920,
                162921,
                162922,
                162923,
                162924,
                162925,
                162926,
                162927,
                162983,
                162984,
                162985,
                162986,
                162987,
                162952,
                162956,
                162955,
                162957,
                162958,
                162959,
                162960,
                162961,
                162962,
                162963,
                162965,
                162966,
                162967,
                162968,
                162969,
                162970,
                162971,
                162973,
                162972,
                162974,
                162976,
                162977,
                162978,
                162981,
                162982,
                163018,
                163019,
                163020,
                163022,
            ],
            (41510, "src-d/go-git"): [],
            (41509, "src-d/go-git"): [
                162939,
                162940,
                162941,
                162942,
                162943,
                162944,
                162945,
                162949,
                162950,
                162946,
                162947,
                162948,
                162951,
            ],
            (41508, "src-d/go-git"): [
                163548,
                163568,
                163570,
                162928,
                162929,
                162930,
                162931,
                162932,
                162933,
                162934,
                162935,
                162936,
                162937,
                162938,
            ],
            (41506, "src-d/go-git"): [163565, 163569],
            (41505, "src-d/go-git"): [
                163511,
                163514,
                163515,
                163516,
                163517,
                163518,
                163527,
                163528,
                163530,
                163531,
                163532,
                163533,
                163534,
                163519,
                163520,
                163521,
                163522,
                163524,
                163525,
                163526,
                163537,
                163538,
                163539,
                163540,
                163541,
                163542,
                163543,
                163544,
                163545,
                163558,
                163559,
                163560,
                163561,
                163562,
                163563,
                163564,
                163566,
                163567,
                163546,
                163547,
                163549,
                163550,
                163551,
                163552,
                163553,
                163554,
                163555,
                163556,
                163557,
                163571,
            ],
            (41503, "src-d/go-git"): [163504, 163505, 163500, 163512, 163509],
            (41502, "src-d/go-git"): [163498, 163499],
            (41501, "src-d/go-git"): [
                163488,
                163481,
                163482,
                163483,
                163484,
                163485,
                163486,
                163494,
                163495,
                163497,
                163490,
                163491,
                163492,
                163493,
                163502,
                163503,
                163506,
                163507,
                163508,
            ],
            (41507, "src-d/go-git"): [
                163466,
                163464,
                163465,
                163467,
                163468,
                163469,
                163470,
                163474,
                163475,
                163478,
                163479,
                163480,
                163487,
            ],
            (41496, "src-d/go-git"): [163462, 163463],
            (41495, "src-d/go-git"): [163458, 163461, 163460],
            (41500, "src-d/go-git"): [],
            (41499, "src-d/go-git"): [163456],
            (41498, "src-d/go-git"): [],
            (41497, "src-d/go-git"): [],
            (41490, "src-d/go-git"): [163437],
            (41488, "src-d/go-git"): [163446],
            (41487, "src-d/go-git"): [163436],
            (41486, "src-d/go-git"): [],
            (41494, "src-d/go-git"): [],
            (41493, "src-d/go-git"): [],
            (41492, "src-d/go-git"): [163430],
            (41491, "src-d/go-git"): [],
        },
        "prs_number": {
            (41475, "src-d/go-git"): [1203],
            (41474, "src-d/go-git"): [1165, 1175, 1179, 1181, 1197, 1199, 1200],
            (41473, "src-d/go-git"): [
                1090,
                1096,
                1097,
                1118,
                1119,
                1121,
                1123,
                1124,
                1125,
                1126,
                1127,
                1128,
                1130,
                1131,
                1132,
                1133,
                1134,
                1136,
                1142,
                1145,
                1146,
                1154,
                1159,
                1160,
                1164,
            ],
            (41472, "src-d/go-git"): [
                1070,
                1072,
                1073,
                1076,
                1080,
                1081,
                1084,
                1088,
                1092,
                1093,
                1094,
                1095,
                1099,
                1112,
                1115,
            ],
            (41471, "src-d/go-git"): [1006, 1060, 1064, 1065, 1066, 1067],
            (41470, "src-d/go-git"): [1056],
            (41469, "src-d/go-git"): [963, 1031, 1036, 1037, 1045],
            (41468, "src-d/go-git"): [1028],
            (41467, "src-d/go-git"): [
                987,
                989,
                990,
                992,
                994,
                998,
                1000,
                1001,
                1004,
                1005,
                1008,
                1009,
                1013,
                1015,
                1019,
                1022,
                1025,
            ],
            (41485, "src-d/go-git"): [
                727,
                828,
                830,
                928,
                932,
                949,
                950,
                958,
                962,
                966,
                968,
                974,
                977,
                978,
                979,
                982,
                984,
                985,
                986,
            ],
            (41484, "src-d/go-git"): [882, 887, 921, 924, 927, 929, 933, 935, 937, 939, 941, 942],
            (41483, "src-d/go-git"): [
                862,
                885,
                888,
                892,
                896,
                898,
                899,
                902,
                904,
                905,
                906,
                907,
                910,
                916,
                920,
            ],
            (41482, "src-d/go-git"): [857, 859, 864, 869, 870, 873, 874],
            (41481, "src-d/go-git"): [845, 846, 848, 854, 855, 856],
            (41480, "src-d/go-git"): [815, 825, 833],
            (41479, "src-d/go-git"): [706, 807, 808, 810],
            (41478, "src-d/go-git"): [784, 803, 804],
            (41477, "src-d/go-git"): [778, 783, 786, 792, 794, 795, 797],
            (41476, "src-d/go-git"): [739, 754, 759, 762, 766, 769, 771],
            (41517, "src-d/go-git"): [721, 724, 731, 740, 742, 744, 749, 751],
            (41519, "src-d/go-git"): [712, 714, 716, 720],
            (41518, "src-d/go-git"): [
                534,
                577,
                579,
                580,
                582,
                583,
                584,
                585,
                586,
                587,
                588,
                608,
                609,
                610,
                613,
                615,
                616,
                617,
                626,
                631,
                632,
                633,
                638,
                640,
                641,
                643,
                646,
                647,
                649,
                650,
                651,
                652,
                653,
                655,
                656,
                657,
                658,
                659,
                660,
                661,
                663,
                664,
                665,
                666,
                667,
                668,
                669,
                672,
                674,
                675,
                677,
                680,
                686,
                687,
                688,
                690,
                695,
                696,
                697,
                698,
                700,
                710,
            ],
            (41514, "src-d/go-git"): [569, 572, 573, 576, 578],
            (41513, "src-d/go-git"): [
                501,
                522,
                526,
                527,
                531,
                532,
                533,
                536,
                538,
                540,
                542,
                543,
                544,
                546,
                552,
                554,
                555,
                558,
                563,
                564,
                565,
                567,
            ],
            (41516, "src-d/go-git"): [
                484,
                487,
                489,
                491,
                492,
                493,
                496,
                498,
                499,
                507,
                509,
                510,
                511,
                512,
                513,
                514,
                515,
                516,
                517,
            ],
            (41515, "src-d/go-git"): [
                414,
                423,
                432,
                451,
                452,
                453,
                464,
                465,
                467,
                469,
                472,
                473,
                475,
                476,
                477,
                478,
                479,
                480,
                485,
            ],
            (41512, "src-d/go-git"): [
                369,
                405,
                409,
                411,
                418,
                421,
                422,
                429,
                434,
                436,
                440,
                441,
                442,
                444,
            ],
            (41511, "src-d/go-git"): [
                139,
                248,
                250,
                251,
                252,
                258,
                259,
                262,
                263,
                265,
                266,
                267,
                268,
                269,
                270,
                273,
                276,
                277,
                278,
                282,
                283,
                284,
                285,
                286,
                287,
                288,
                289,
                292,
                293,
                294,
                295,
                296,
                297,
                299,
                300,
                302,
                303,
                305,
                314,
                316,
                319,
                320,
                324,
                331,
                333,
                334,
                336,
                337,
                339,
                344,
                346,
                347,
                355,
                356,
                360,
                361,
                363,
                364,
                365,
                366,
                367,
                368,
                374,
                375,
                381,
                384,
                388,
                394,
                395,
                398,
                400,
            ],
            (41510, "src-d/go-git"): [],
            (41509, "src-d/go-git"): [
                218,
                219,
                221,
                224,
                227,
                229,
                230,
                233,
                235,
                237,
                240,
                241,
                244,
            ],
            (41508, "src-d/go-git"): [
                178,
                190,
                192,
                200,
                201,
                204,
                205,
                207,
                209,
                210,
                212,
                213,
                214,
                215,
            ],
            (41506, "src-d/go-git"): [173, 191],
            (41505, "src-d/go-git"): [
                121,
                130,
                131,
                132,
                133,
                135,
                136,
                138,
                140,
                141,
                142,
                143,
                144,
                145,
                146,
                147,
                148,
                150,
                151,
                153,
                157,
                158,
                159,
                160,
                161,
                162,
                163,
                164,
                165,
                166,
                167,
                168,
                169,
                170,
                171,
                172,
                174,
                175,
                176,
                177,
                179,
                180,
                181,
                182,
                183,
                185,
                186,
                187,
                188,
                189,
            ],
            (41503, "src-d/go-git"): [111, 112, 118, 122, 124],
            (41502, "src-d/go-git"): [116, 117],
            (41501, "src-d/go-git"): [
                91,
                92,
                93,
                94,
                95,
                96,
                97,
                99,
                100,
                102,
                104,
                105,
                106,
                108,
                109,
                110,
                113,
                114,
                115,
            ],
            (41507, "src-d/go-git"): [63, 64, 66, 68, 69, 70, 74, 83, 84, 87, 88, 89, 90],
            (41496, "src-d/go-git"): [58, 61],
            (41495, "src-d/go-git"): [54, 55, 56],
            (41500, "src-d/go-git"): [],
            (41499, "src-d/go-git"): [47],
            (41498, "src-d/go-git"): [],
            (41497, "src-d/go-git"): [],
            (41490, "src-d/go-git"): [20],
            (41488, "src-d/go-git"): [24],
            (41487, "src-d/go-git"): [15],
            (41486, "src-d/go-git"): [],
            (41494, "src-d/go-git"): [],
            (41493, "src-d/go-git"): [],
            (41492, "src-d/go-git"): [9],
            (41491, "src-d/go-git"): [],
        },
        "prs_additions": {
            (41475, "src-d/go-git"): [1],
            (41474, "src-d/go-git"): [129, 1, 83, 3, 5, 40, 30],
            (41473, "src-d/go-git"): [
                68,
                256,
                971,
                73,
                26,
                126,
                143,
                143,
                34,
                46,
                57,
                689,
                1043,
                41,
                961,
                4,
                61,
                28,
                82,
                47,
                42,
                26,
                10,
                62,
                1,
            ],
            (41472, "src-d/go-git"): [33, 1, 1, 19, 17, 0, 17, 87, 1, 67, 47, 4, 1, 1, 40],
            (41471, "src-d/go-git"): [1161, 27, 7, 62, 104, 85],
            (41470, "src-d/go-git"): [21],
            (41469, "src-d/go-git"): [126, 25, 73, 1, 357],
            (41468, "src-d/go-git"): [57],
            (41467, "src-d/go-git"): [
                30,
                1,
                128,
                27,
                95,
                55,
                2,
                50,
                17,
                3,
                156,
                8,
                11,
                45,
                61,
                0,
                122,
            ],
            (41485, "src-d/go-git"): [
                8983,
                19,
                54,
                662,
                43,
                111,
                69,
                66,
                64,
                2,
                15,
                1,
                14,
                1,
                271,
                168,
                9,
                3,
                42,
            ],
            (41484, "src-d/go-git"): [68, 101, 45, 9, 85, 41, 98, 36, 7, 6, 260, 131],
            (41483, "src-d/go-git"): [
                2,
                8,
                83,
                45,
                484,
                831,
                725,
                49,
                132,
                3,
                2949,
                88,
                32,
                276,
                178,
            ],
            (41482, "src-d/go-git"): [9, 39, 82, 12, 49, 2, 297],
            (41481, "src-d/go-git"): [4, 67, 73, 9, 26, 19],
            (41480, "src-d/go-git"): [62, 285, 22],
            (41479, "src-d/go-git"): [33, 23, 1, 132],
            (41478, "src-d/go-git"): [73, 507, 0],
            (41477, "src-d/go-git"): [39, 26, 48, 172, 59, 10, 19],
            (41476, "src-d/go-git"): [779, 7, 9, 12, 14, 61, 329],
            (41517, "src-d/go-git"): [25, 106, 56, 1, 2, 18, 43, 56],
            (41519, "src-d/go-git"): [19, 56, 19, 24],
            (41518, "src-d/go-git"): [
                24,
                43,
                38,
                73,
                367,
                1,
                3,
                1,
                45,
                146,
                84,
                23,
                70,
                97,
                167,
                4,
                69,
                1,
                36,
                13,
                6,
                2,
                1,
                40,
                1,
                1,
                29,
                20,
                59,
                278,
                29,
                39,
                95,
                84,
                3,
                3,
                172,
                2,
                82,
                23,
                148,
                1,
                205,
                76,
                56,
                6,
                928,
                22,
                1,
                67,
                51,
                336,
                324,
                110,
                1,
                14,
                124,
                4,
                152,
                113,
                142,
                1,
            ],
            (41514, "src-d/go-git"): [15, 277, 118, 57, 33],
            (41513, "src-d/go-git"): [
                219,
                11,
                61,
                75,
                37,
                44,
                15,
                33,
                20,
                6,
                12,
                22,
                39,
                61,
                56,
                2,
                48,
                62,
                76,
                43,
                23,
                48,
            ],
            (41516, "src-d/go-git"): [
                46,
                116,
                166,
                118,
                85,
                95,
                18,
                152,
                271,
                387,
                300,
                318,
                109,
                123,
                91,
                154,
                493,
                28,
                4,
            ],
            (41515, "src-d/go-git"): [
                2,
                36,
                266,
                6,
                1,
                1,
                31,
                23,
                95,
                76,
                35,
                3,
                42,
                49,
                0,
                61,
                32,
                51,
                205,
            ],
            (41512, "src-d/go-git"): [25, 15, 37, 35, 189, 11, 7, 758, 69, 198, 24, 56, 6, 35],
            (41511, "src-d/go-git"): [
                1546,
                637,
                109,
                19,
                873,
                71,
                110,
                1246,
                52,
                4,
                12,
                4,
                12,
                206,
                1092,
                1269,
                302,
                0,
                1,
                26,
                3,
                67,
                72,
                25,
                1,
                56,
                21,
                144,
                29,
                22,
                52,
                426,
                784,
                5,
                31,
                26,
                483,
                59,
                36,
                1,
                30,
                6,
                62,
                45,
                22,
                14,
                14,
                331,
                1288,
                483,
                93,
                68,
                35,
                41,
                22,
                205,
                142,
                38,
                201,
                151,
                45,
                114,
                10,
                559,
                68,
                117,
                1614,
                20,
                206,
                74,
                94,
            ],
            (41510, "src-d/go-git"): [],
            (41509, "src-d/go-git"): [248, 18, 32, 57, 389, 1320, 10, 3, 2, 87, 1, 1466, 32],
            (41508, "src-d/go-git"): [565, 1641, 1, 204, 20, 16, 7, 93, 15, 116, 7, 15, 19, 15],
            (41506, "src-d/go-git"): [46, 2],
            (41505, "src-d/go-git"): [
                205,
                154,
                272,
                1521,
                1004,
                270,
                512,
                0,
                65,
                482,
                465,
                466,
                819,
                484,
                1,
                759,
                15,
                3,
                493,
                11,
                12,
                164,
                637,
                175,
                580,
                402,
                692,
                139,
                23,
                37,
                8,
                30,
                6,
                14,
                1,
                352,
                1,
                272,
                293,
                86,
                1,
                240,
                79,
                474,
                974,
                283,
                13,
                27,
                109,
                1,
            ],
            (41503, "src-d/go-git"): [189, 548, 2000, 46, 31],
            (41502, "src-d/go-git"): [9, 24],
            (41501, "src-d/go-git"): [
                1069,
                2946,
                108,
                28,
                8,
                91,
                1017,
                18,
                56,
                340,
                163,
                362,
                1493,
                442,
                23,
                241,
                2,
                440,
                1,
            ],
            (41507, "src-d/go-git"): [595, 1207, 1, 324, 171, 240, 0, 1, 723, 8, 236, 408, 4],
            (41496, "src-d/go-git"): [83, 147],
            (41495, "src-d/go-git"): [1320, 6630, 498],
            (41500, "src-d/go-git"): [],
            (41499, "src-d/go-git"): [5],
            (41498, "src-d/go-git"): [],
            (41497, "src-d/go-git"): [],
            (41490, "src-d/go-git"): [274],
            (41488, "src-d/go-git"): [1],
            (41487, "src-d/go-git"): [224],
            (41486, "src-d/go-git"): [],
            (41494, "src-d/go-git"): [],
            (41493, "src-d/go-git"): [],
            (41492, "src-d/go-git"): [132],
            (41491, "src-d/go-git"): [],
        },
        "prs_deletions": {
            (41475, "src-d/go-git"): [1],
            (41474, "src-d/go-git"): [16, 1, 18, 3, 5, 49, 10],
            (41473, "src-d/go-git"): [
                2,
                7,
                0,
                1,
                4,
                56,
                49,
                105,
                9,
                19,
                4,
                0,
                0,
                33,
                6,
                6,
                63,
                51,
                37,
                0,
                49,
                2,
                11,
                11,
                1,
            ],
            (41472, "src-d/go-git"): [1, 1, 1, 1, 1, 11, 1, 2, 1, 9, 0, 1, 1, 1, 15],
            (41471, "src-d/go-git"): [8, 1, 6, 14, 17, 11],
            (41470, "src-d/go-git"): [5],
            (41469, "src-d/go-git"): [61, 1, 50, 5, 32],
            (41468, "src-d/go-git"): [19],
            (41467, "src-d/go-git"): [2, 1, 0, 1, 47, 0, 1, 0, 17, 1, 6, 1, 3, 15, 0, 56, 4],
            (41485, "src-d/go-git"): [
                2116,
                5,
                11,
                69,
                2,
                165,
                7,
                24,
                12,
                2,
                5,
                1,
                1,
                1,
                6,
                0,
                14,
                2,
                5,
            ],
            (41484, "src-d/go-git"): [0, 3, 5, 0, 1, 2, 34, 18, 0, 2, 9, 2],
            (41483, "src-d/go-git"): [1, 3, 0, 18, 387, 47, 173, 135, 32, 2, 1539, 43, 6, 53, 7],
            (41482, "src-d/go-git"): [8, 1, 94, 2, 5, 2, 9],
            (41481, "src-d/go-git"): [4, 23, 12, 10, 1, 4],
            (41480, "src-d/go-git"): [8, 7, 2],
            (41479, "src-d/go-git"): [8, 3, 0, 2],
            (41478, "src-d/go-git"): [6, 7, 0],
            (41477, "src-d/go-git"): [0, 1, 0, 9, 39, 2, 2],
            (41476, "src-d/go-git"): [38, 2, 0, 2, 83, 22, 3],
            (41517, "src-d/go-git"): [1, 13, 2, 1, 2, 8, 2, 10],
            (41519, "src-d/go-git"): [4, 12, 13, 6],
            (41518, "src-d/go-git"): [
                0,
                0,
                11,
                40,
                56,
                1,
                17,
                1,
                15,
                42,
                3,
                3,
                0,
                4,
                0,
                4,
                0,
                1,
                11,
                4,
                0,
                2,
                1,
                0,
                0,
                1,
                4,
                20,
                55,
                269,
                48,
                2,
                0,
                89,
                2,
                1,
                7,
                2,
                54,
                2,
                1,
                1,
                22,
                6,
                118,
                7,
                74,
                22,
                1,
                0,
                5,
                19,
                1,
                0,
                1,
                18,
                35,
                11,
                29,
                68,
                33,
                1,
            ],
            (41514, "src-d/go-git"): [10, 130, 6, 13, 6],
            (41513, "src-d/go-git"): [
                81,
                8,
                2,
                2,
                39,
                15,
                7,
                1,
                6,
                0,
                4,
                1,
                0,
                1,
                38,
                2,
                0,
                12,
                24,
                11,
                1,
                3,
            ],
            (41516, "src-d/go-git"): [
                1,
                23,
                41,
                47,
                16,
                51,
                0,
                171,
                271,
                42,
                66,
                138,
                6,
                2,
                89,
                113,
                93,
                1,
                3,
            ],
            (41515, "src-d/go-git"): [
                2,
                3,
                77,
                10,
                1,
                1,
                21,
                18,
                12,
                17,
                41,
                2,
                23,
                7,
                5,
                36,
                3,
                16,
                109,
            ],
            (41512, "src-d/go-git"): [31, 14, 15, 1, 39, 11, 5, 0, 25, 27, 1, 115, 6, 7],
            (41511, "src-d/go-git"): [
                0,
                834,
                2,
                17,
                0,
                10,
                56,
                13,
                54,
                18,
                5,
                45,
                1,
                14,
                131,
                536,
                81,
                1900,
                1,
                3,
                3,
                66,
                9,
                1,
                0,
                11,
                16,
                98,
                2,
                16,
                42,
                43,
                283,
                5,
                51,
                2,
                483,
                7,
                2,
                1,
                7,
                1,
                0,
                3,
                6,
                14,
                8,
                173,
                292,
                58,
                2,
                23,
                9,
                13,
                21,
                4,
                9,
                37,
                62,
                22,
                1,
                52,
                0,
                54,
                0,
                0,
                1,
                4,
                2,
                0,
                441,
            ],
            (41510, "src-d/go-git"): [],
            (41509, "src-d/go-git"): [8, 7, 8, 5, 98, 345, 10, 3, 2, 62, 1, 1004, 32],
            (41508, "src-d/go-git"): [33, 308, 1, 28, 5, 2, 1, 26, 3, 127, 0, 14, 5, 3],
            (41506, "src-d/go-git"): [1183, 2],
            (41505, "src-d/go-git"): [
                77,
                51,
                15,
                1400,
                0,
                0,
                240,
                0,
                14,
                523,
                532,
                0,
                474,
                333,
                0,
                0,
                3,
                1,
                105,
                8,
                32,
                42,
                0,
                58,
                67,
                4,
                62,
                76,
                31,
                1,
                1,
                27,
                9,
                0,
                1,
                25,
                1,
                37,
                543,
                16,
                1,
                1,
                133,
                112,
                771,
                273,
                31,
                24,
                9,
                4,
            ],
            (41503, "src-d/go-git"): [190, 730, 1933, 2, 3],
            (41502, "src-d/go-git"): [1, 1],
            (41501, "src-d/go-git"): [
                0,
                636,
                115,
                0,
                0,
                52,
                54,
                0,
                24,
                315,
                52,
                78,
                34,
                12,
                22,
                94,
                1,
                119,
                0,
            ],
            (41507, "src-d/go-git"): [1, 2, 1, 8, 140, 4, 598, 1, 417, 2, 159, 349, 0],
            (41496, "src-d/go-git"): [1, 12],
            (41495, "src-d/go-git"): [0, 924, 9],
            (41500, "src-d/go-git"): [],
            (41499, "src-d/go-git"): [6],
            (41498, "src-d/go-git"): [],
            (41497, "src-d/go-git"): [],
            (41490, "src-d/go-git"): [101],
            (41488, "src-d/go-git"): [1],
            (41487, "src-d/go-git"): [17],
            (41486, "src-d/go-git"): [],
            (41494, "src-d/go-git"): [],
            (41493, "src-d/go-git"): [],
            (41492, "src-d/go-git"): [196],
            (41491, "src-d/go-git"): [],
        },
        "prs_user_node_id": {
            (41475, "src-d/go-git"): [40187],
            (41474, "src-d/go-git"): [40292, 40025, 39887, 39771, 40152, 39789, 39789],
            (41473, "src-d/go-git"): [
                39890,
                39974,
                39974,
                39828,
                39828,
                39828,
                39868,
                39868,
                39868,
                39868,
                40187,
                39828,
                39868,
                39789,
                39828,
                39828,
                39828,
                39828,
                40114,
                40146,
                40410,
                39994,
                40083,
                40410,
                40158,
            ],
            (41472, "src-d/go-git"): [
                40375,
                40243,
                40243,
                39849,
                39849,
                40021,
                40020,
                39982,
                40298,
                39849,
                40298,
                40298,
                39974,
                40138,
                39789,
            ],
            (41471, "src-d/go-git"): [39789, 40374, 40039, 40020, 40374, 39926],
            (41470, "src-d/go-git"): [39849],
            (41469, "src-d/go-git"): [39828, 39849, 39849, 40328, 40189],
            (41468, "src-d/go-git"): [40070],
            (41467, "src-d/go-git"): [
                40061,
                40031,
                40228,
                40261,
                39913,
                39789,
                40070,
                40044,
                39798,
                40044,
                40070,
                40070,
                40228,
                40414,
                39913,
                39926,
                39789,
            ],
            (41485, "src-d/go-git"): [
                39968,
                40186,
                40410,
                39900,
                39916,
                40189,
                40189,
                40189,
                39849,
                40095,
                40070,
                39764,
                39828,
                40377,
                40181,
                40374,
                39789,
                39789,
                39789,
            ],
            (41484, "src-d/go-git"): [
                39863,
                39757,
                39849,
                40414,
                39849,
                39849,
                40189,
                39849,
                40076,
                40197,
                39849,
                39849,
            ],
            (41483, "src-d/go-git"): [
                40165,
                40266,
                40345,
                39849,
                39957,
                39849,
                39957,
                39849,
                39849,
                39926,
                39957,
                39957,
                40414,
                39849,
                39900,
            ],
            (41482, "src-d/go-git"): [39957, 40107, 40070, 40135, 39789, 40070, 40070],
            (41481, "src-d/go-git"): [40135, 40135, 39788, 39926, 39849, 40189],
            (41480, "src-d/go-git"): [40189, 39804, 39849],
            (41479, "src-d/go-git"): [40175, 40374, 39849, 39849],
            (41478, "src-d/go-git"): [40093, 39845, 40068],
            (41477, "src-d/go-git"): [39896, 39804, 39789, 39926, 39849, 39881, 39788],
            (41476, "src-d/go-git"): [39789, 39881, 40287, 40038, 40093, 40294, 39874],
            (41517, "src-d/go-git"): [40090, 39849, 39849, 40283, 40288, 39849, 0, 39789],
            (41519, "src-d/go-git"): [39849, 39800, 39849, 39849],
            (41518, "src-d/go-git"): [
                40293,
                40059,
                39957,
                39957,
                39957,
                40246,
                39957,
                40230,
                40374,
                40374,
                39957,
                40052,
                40319,
                40374,
                40319,
                40109,
                40319,
                40109,
                40239,
                40374,
                40374,
                40170,
                40051,
                39962,
                39844,
                39989,
                39789,
                40283,
                39789,
                39789,
                39957,
                40283,
                40319,
                39789,
                40319,
                39926,
                40319,
                40283,
                40175,
                40283,
                40319,
                40239,
                40374,
                40374,
                40283,
                39936,
                40374,
                40283,
                40283,
                40319,
                39968,
                39789,
                40319,
                39980,
                40319,
                39789,
                40319,
                40283,
                39926,
                39849,
                39849,
                40392,
            ],
            (41514, "src-d/go-git"): [39957, 39789, 40239, 39789, 39957],
            (41513, "src-d/go-git"): [
                40070,
                39799,
                40123,
                40374,
                39789,
                39789,
                39818,
                39818,
                40421,
                39818,
                39818,
                39957,
                39957,
                40239,
                39818,
                40374,
                39789,
                40239,
                39957,
                40374,
                40374,
                40374,
            ],
            (41516, "src-d/go-git"): [
                40239,
                39789,
                39789,
                40070,
                39926,
                39789,
                39912,
                39789,
                39789,
                39789,
                39789,
                40070,
                39789,
                39789,
                39789,
                40070,
                40070,
                40070,
                40070,
            ],
            (41515, "src-d/go-git"): [
                40045,
                40070,
                39926,
                40070,
                39891,
                40070,
                40070,
                40070,
                40070,
                39789,
                40070,
                39891,
                39789,
                40070,
                39891,
                39789,
                39789,
                39789,
                39789,
            ],
            (41512, "src-d/go-git"): [
                40070,
                40317,
                40070,
                39926,
                40070,
                40070,
                40070,
                40336,
                40239,
                39789,
                39926,
                39789,
                39926,
                40336,
            ],
            (41511, "src-d/go-git"): [
                40175,
                39789,
                39789,
                40385,
                40418,
                39926,
                40070,
                40418,
                40070,
                40418,
                40418,
                40418,
                40418,
                40070,
                39789,
                40418,
                40418,
                39926,
                39926,
                39789,
                39789,
                39926,
                40418,
                39926,
                39926,
                39926,
                39926,
                39926,
                39926,
                39926,
                39926,
                39926,
                40418,
                39926,
                40418,
                40284,
                39926,
                40093,
                39912,
                39906,
                39926,
                39912,
                39926,
                39800,
                39891,
                39891,
                40073,
                39926,
                39789,
                39789,
                39789,
                39789,
                39789,
                39789,
                40070,
                39789,
                40070,
                39789,
                40070,
                40070,
                40070,
                40070,
                39926,
                39789,
                39789,
                40070,
                39926,
                39926,
                39789,
                39789,
                39926,
            ],
            (41510, "src-d/go-git"): [],
            (41509, "src-d/go-git"): [
                39926,
                39926,
                39926,
                40418,
                39789,
                39789,
                40096,
                40096,
                40096,
                39789,
                40096,
                40418,
                40096,
            ],
            (41508, "src-d/go-git"): [
                40070,
                40070,
                39957,
                39926,
                39926,
                39789,
                40070,
                39789,
                39789,
                39921,
                39926,
                40418,
                39926,
                40070,
            ],
            (41506, "src-d/go-git"): [40096, 40070],
            (41505, "src-d/go-git"): [
                40283,
                39789,
                39926,
                40070,
                40418,
                39926,
                40070,
                40418,
                39789,
                40070,
                40070,
                39789,
                39789,
                40070,
                40070,
                40070,
                39789,
                40070,
                39789,
                40070,
                40070,
                39789,
                39926,
                40070,
                39789,
                40070,
                40070,
                39789,
                40070,
                40070,
                40070,
                40070,
                40070,
                40070,
                40070,
                39926,
                40096,
                39789,
                39789,
                39789,
                40070,
                39789,
                39789,
                39926,
                40070,
                40070,
                39926,
                40070,
                39926,
                39789,
            ],
            (41503, "src-d/go-git"): [40283, 39789, 39789, 40070, 40418],
            (41502, "src-d/go-git"): [40303, 40070],
            (41501, "src-d/go-git"): [
                39789,
                40418,
                40070,
                40070,
                40070,
                40418,
                40070,
                40070,
                39789,
                39789,
                40070,
                39789,
                40418,
                39789,
                40394,
                40070,
                39926,
                40070,
                39926,
            ],
            (41507, "src-d/go-git"): [
                40418,
                40418,
                40020,
                39791,
                40070,
                40070,
                40070,
                40283,
                40418,
                40418,
                39789,
                40418,
                40070,
            ],
            (41496, "src-d/go-git"): [40020, 40418],
            (41495, "src-d/go-git"): [40020, 40418, 40020],
            (41500, "src-d/go-git"): [],
            (41499, "src-d/go-git"): [39758],
            (41498, "src-d/go-git"): [],
            (41497, "src-d/go-git"): [],
            (41490, "src-d/go-git"): [40058],
            (41488, "src-d/go-git"): [40389],
            (41487, "src-d/go-git"): [40418],
            (41486, "src-d/go-git"): [],
            (41494, "src-d/go-git"): [],
            (41493, "src-d/go-git"): [],
            (41492, "src-d/go-git"): [39789],
            (41491, "src-d/go-git"): [],
        },
        "age": {
            (41475, "src-d/go-git"): timedelta(days=1, hours=1, minutes=44, seconds=14),
            (41474, "src-d/go-git"): timedelta(days=42, hours=14, minutes=43, seconds=54),
            (41473, "src-d/go-git"): timedelta(days=61, hours=12, minutes=0, seconds=20),
            (41472, "src-d/go-git"): timedelta(days=62, hours=23, minutes=2, seconds=57),
            (41471, "src-d/go-git"): timedelta(days=14, hours=17, minutes=40, seconds=53),
            (41470, "src-d/go-git"): timedelta(days=0, hours=8, minutes=9, seconds=17),
            (41469, "src-d/go-git"): timedelta(days=63, hours=18, minutes=40, seconds=9),
            (41468, "src-d/go-git"): timedelta(days=7, hours=16, minutes=47, seconds=44),
            (41467, "src-d/go-git"): timedelta(days=34, hours=12, minutes=49, seconds=2),
            (41485, "src-d/go-git"): timedelta(days=39, hours=2, minutes=41, seconds=13),
            (41484, "src-d/go-git"): timedelta(days=20, hours=20, minutes=44, seconds=28),
            (41483, "src-d/go-git"): timedelta(days=38, hours=0, minutes=24, seconds=1),
            (41482, "src-d/go-git"): timedelta(days=32, hours=2, minutes=17, seconds=6),
            (41481, "src-d/go-git"): timedelta(days=22, hours=21, minutes=6, seconds=20),
            (41480, "src-d/go-git"): timedelta(days=28, hours=20, minutes=58, seconds=21),
            (41479, "src-d/go-git"): timedelta(days=6, hours=5, minutes=4, seconds=0),
            (41478, "src-d/go-git"): timedelta(days=8, hours=0, minutes=24, seconds=48),
            (41477, "src-d/go-git"): timedelta(days=21, hours=21, minutes=36, seconds=25),
            (41476, "src-d/go-git"): timedelta(days=22, hours=22, minutes=10, seconds=14),
            (41517, "src-d/go-git"): timedelta(days=31, hours=22, minutes=37, seconds=43),
            (41519, "src-d/go-git"): timedelta(days=8, hours=0, minutes=35, seconds=15),
            (41518, "src-d/go-git"): timedelta(days=125, hours=19, minutes=12, seconds=28),
            (41514, "src-d/go-git"): timedelta(days=6, hours=22, minutes=37, seconds=2),
            (41513, "src-d/go-git"): timedelta(days=30, hours=23, minutes=13, seconds=34),
            (41516, "src-d/go-git"): timedelta(days=11, hours=12, minutes=2, seconds=59),
            (41515, "src-d/go-git"): timedelta(days=24, hours=9, minutes=43, seconds=53),
            (41512, "src-d/go-git"): timedelta(days=29, hours=12, minutes=4, seconds=34),
            (41511, "src-d/go-git"): timedelta(days=112, hours=0, minutes=21, seconds=38),
            (41510, "src-d/go-git"): timedelta(days=0, hours=23, minutes=48, seconds=24),
            (41509, "src-d/go-git"): timedelta(days=11, hours=20, minutes=29, seconds=13),
            (41508, "src-d/go-git"): timedelta(days=30, hours=19, minutes=53, seconds=48),
            (41506, "src-d/go-git"): timedelta(days=2, hours=19, minutes=45, seconds=31),
            (41505, "src-d/go-git"): timedelta(days=32, hours=0, minutes=38, seconds=29),
            (41503, "src-d/go-git"): timedelta(days=7, hours=10, minutes=12, seconds=43),
            (41502, "src-d/go-git"): timedelta(days=2, hours=19, minutes=38, seconds=14),
            (41501, "src-d/go-git"): timedelta(days=38, hours=4, minutes=41, seconds=13),
            (41507, "src-d/go-git"): timedelta(days=56, hours=1, minutes=44, seconds=25),
            (41496, "src-d/go-git"): timedelta(days=27, hours=20, minutes=28, seconds=23),
            (41495, "src-d/go-git"): timedelta(days=47, hours=0, minutes=55, seconds=47),
            (41500, "src-d/go-git"): timedelta(days=8, hours=23, minutes=17, seconds=32),
            (41499, "src-d/go-git"): timedelta(days=15, hours=4, minutes=52, seconds=38),
            (41498, "src-d/go-git"): timedelta(days=2, hours=21, minutes=47, seconds=6),
            (41497, "src-d/go-git"): timedelta(days=58, hours=9, minutes=34, seconds=39),
            (41490, "src-d/go-git"): timedelta(days=7, hours=7, minutes=24, seconds=3),
            (41488, "src-d/go-git"): timedelta(days=20, hours=5, minutes=30, seconds=41),
            (41487, "src-d/go-git"): timedelta(days=15, hours=23, minutes=41, seconds=53),
            (41486, "src-d/go-git"): timedelta(days=2, hours=19, minutes=24, seconds=15),
            (41494, "src-d/go-git"): timedelta(days=1, hours=0, minutes=57, seconds=12),
            (41493, "src-d/go-git"): timedelta(days=25, hours=14, minutes=50, seconds=16),
            (41492, "src-d/go-git"): timedelta(days=51, hours=13, minutes=1, seconds=36),
            (41491, "src-d/go-git"): timedelta(days=199, hours=9, minutes=1, seconds=5),
        },
        "additions": {
            (41475, "src-d/go-git"): 2,
            (41474, "src-d/go-git"): 499,
            (41473, "src-d/go-git"): 11841,
            (41472, "src-d/go-git"): 633,
            (41471, "src-d/go-git"): 2922,
            (41470, "src-d/go-git"): 42,
            (41469, "src-d/go-git"): 1177,
            (41468, "src-d/go-git"): 114,
            (41467, "src-d/go-git"): 1971,
            (41485, "src-d/go-git"): 10461,
            (41484, "src-d/go-git"): 1886,
            (41483, "src-d/go-git"): 10316,
            (41482, "src-d/go-git"): 980,
            (41481, "src-d/go-git"): 396,
            (41480, "src-d/go-git"): 453,
            (41479, "src-d/go-git"): 380,
            (41478, "src-d/go-git"): 1160,
            (41477, "src-d/go-git"): 747,
            (41476, "src-d/go-git"): 2497,
            (41517, "src-d/go-git"): 625,
            (41519, "src-d/go-git"): 304,
            (41518, "src-d/go-git"): 10699,
            (41514, "src-d/go-git"): 1000,
            (41513, "src-d/go-git"): 1985,
            (41516, "src-d/go-git"): 6312,
            (41515, "src-d/go-git"): 2052,
            (41512, "src-d/go-git"): 3285,
            (41511, "src-d/go-git"): 30744,
            (41510, "src-d/go-git"): 323,
            (41509, "src-d/go-git"): 6473,
            (41508, "src-d/go-git"): 2734,
            (41506, "src-d/go-git"): 48,
            (41505, "src-d/go-git"): 14670,
            (41503, "src-d/go-git"): 2814,
            (41502, "src-d/go-git"): 37,
            (41501, "src-d/go-git"): 8942,
            (41507, "src-d/go-git"): 17069,
            (41496, "src-d/go-git"): 230,
            (41495, "src-d/go-git"): 10317,
            (41500, "src-d/go-git"): 16,
            (41499, "src-d/go-git"): 10,
            (41498, "src-d/go-git"): 114,
            (41497, "src-d/go-git"): 2399,
            (41490, "src-d/go-git"): 3327,
            (41488, "src-d/go-git"): 392,
            (41487, "src-d/go-git"): 620,
            (41486, "src-d/go-git"): 26,
            (41494, "src-d/go-git"): 68,
            (41493, "src-d/go-git"): 407,
            (41492, "src-d/go-git"): 10464,
            (41491, "src-d/go-git"): 1884,
        },
        "deletions": {
            (41475, "src-d/go-git"): 2,
            (41474, "src-d/go-git"): 186,
            (41473, "src-d/go-git"): 1664,
            (41472, "src-d/go-git"): 80,
            (41471, "src-d/go-git"): 144,
            (41470, "src-d/go-git"): 10,
            (41469, "src-d/go-git"): 376,
            (41468, "src-d/go-git"): 38,
            (41467, "src-d/go-git"): 338,
            (41485, "src-d/go-git"): 2857,
            (41484, "src-d/go-git"): 283,
            (41483, "src-d/go-git"): 4930,
            (41482, "src-d/go-git"): 242,
            (41481, "src-d/go-git"): 108,
            (41480, "src-d/go-git"): 28,
            (41479, "src-d/go-git"): 26,
            (41478, "src-d/go-git"): 26,
            (41477, "src-d/go-git"): 107,
            (41476, "src-d/go-git"): 374,
            (41517, "src-d/go-git"): 89,
            (41519, "src-d/go-git"): 133,
            (41518, "src-d/go-git"): 3354,
            (41514, "src-d/go-git"): 330,
            (41513, "src-d/go-git"): 515,
            (41516, "src-d/go-git"): 2475,
            (41515, "src-d/go-git"): 830,
            (41512, "src-d/go-git"): 954,
            (41511, "src-d/go-git"): 12512,
            (41510, "src-d/go-git"): 146,
            (41509, "src-d/go-git"): 3562,
            (41508, "src-d/go-git"): 556,
            (41506, "src-d/go-git"): 1185,
            (41505, "src-d/go-git"): 6763,
            (41503, "src-d/go-git"): 2858,
            (41502, "src-d/go-git"): 3,
            (41501, "src-d/go-git"): 1551,
            (41507, "src-d/go-git"): 13498,
            (41496, "src-d/go-git"): 13,
            (41495, "src-d/go-git"): 978,
            (41500, "src-d/go-git"): 14,
            (41499, "src-d/go-git"): 12,
            (41498, "src-d/go-git"): 14,
            (41497, "src-d/go-git"): 616,
            (41490, "src-d/go-git"): 883,
            (41488, "src-d/go-git"): 163,
            (41487, "src-d/go-git"): 54,
            (41486, "src-d/go-git"): 6,
            (41494, "src-d/go-git"): 2,
            (41493, "src-d/go-git"): 101,
            (41492, "src-d/go-git"): 3402,
            (41491, "src-d/go-git"): 287,
        },
        "commits_count": {
            (41475, "src-d/go-git"): 2,
            (41474, "src-d/go-git"): 20,
            (41473, "src-d/go-git"): 88,
            (41472, "src-d/go-git"): 32,
            (41471, "src-d/go-git"): 19,
            (41470, "src-d/go-git"): 2,
            (41469, "src-d/go-git"): 13,
            (41468, "src-d/go-git"): 2,
            (41467, "src-d/go-git"): 35,
            (41485, "src-d/go-git"): 62,
            (41484, "src-d/go-git"): 39,
            (41483, "src-d/go-git"): 60,
            (41482, "src-d/go-git"): 14,
            (41481, "src-d/go-git"): 14,
            (41480, "src-d/go-git"): 6,
            (41479, "src-d/go-git"): 10,
            (41478, "src-d/go-git"): 6,
            (41477, "src-d/go-git"): 17,
            (41476, "src-d/go-git"): 21,
            (41517, "src-d/go-git"): 21,
            (41519, "src-d/go-git"): 13,
            (41518, "src-d/go-git"): 181,
            (41514, "src-d/go-git"): 11,
            (41513, "src-d/go-git"): 48,
            (41516, "src-d/go-git"): 62,
            (41515, "src-d/go-git"): 42,
            (41512, "src-d/go-git"): 46,
            (41511, "src-d/go-git"): 195,
            (41510, "src-d/go-git"): 7,
            (41509, "src-d/go-git"): 34,
            (41508, "src-d/go-git"): 14,
            (41506, "src-d/go-git"): 2,
            (41505, "src-d/go-git"): 58,
            (41503, "src-d/go-git"): 6,
            (41502, "src-d/go-git"): 3,
            (41501, "src-d/go-git"): 23,
            (41507, "src-d/go-git"): 110,
            (41496, "src-d/go-git"): 2,
            (41495, "src-d/go-git"): 8,
            (41500, "src-d/go-git"): 2,
            (41499, "src-d/go-git"): 2,
            (41498, "src-d/go-git"): 4,
            (41497, "src-d/go-git"): 12,
            (41490, "src-d/go-git"): 25,
            (41488, "src-d/go-git"): 30,
            (41487, "src-d/go-git"): 9,
            (41486, "src-d/go-git"): 2,
            (41494, "src-d/go-git"): 2,
            (41493, "src-d/go-git"): 4,
            (41492, "src-d/go-git"): 47,
            (41491, "src-d/go-git"): 21,
        },
        "repository_node_id": {
            (41475, "src-d/go-git"): 40550,
            (41474, "src-d/go-git"): 40550,
            (41473, "src-d/go-git"): 40550,
            (41472, "src-d/go-git"): 40550,
            (41471, "src-d/go-git"): 40550,
            (41470, "src-d/go-git"): 40550,
            (41469, "src-d/go-git"): 40550,
            (41468, "src-d/go-git"): 40550,
            (41467, "src-d/go-git"): 40550,
            (41485, "src-d/go-git"): 40550,
            (41484, "src-d/go-git"): 40550,
            (41483, "src-d/go-git"): 40550,
            (41482, "src-d/go-git"): 40550,
            (41481, "src-d/go-git"): 40550,
            (41480, "src-d/go-git"): 40550,
            (41479, "src-d/go-git"): 40550,
            (41478, "src-d/go-git"): 40550,
            (41477, "src-d/go-git"): 40550,
            (41476, "src-d/go-git"): 40550,
            (41517, "src-d/go-git"): 40550,
            (41519, "src-d/go-git"): 40550,
            (41518, "src-d/go-git"): 40550,
            (41514, "src-d/go-git"): 40550,
            (41513, "src-d/go-git"): 40550,
            (41516, "src-d/go-git"): 40550,
            (41515, "src-d/go-git"): 40550,
            (41512, "src-d/go-git"): 40550,
            (41511, "src-d/go-git"): 40550,
            (41510, "src-d/go-git"): 40550,
            (41509, "src-d/go-git"): 40550,
            (41508, "src-d/go-git"): 40550,
            (41506, "src-d/go-git"): 40550,
            (41505, "src-d/go-git"): 40550,
            (41503, "src-d/go-git"): 40550,
            (41502, "src-d/go-git"): 40550,
            (41501, "src-d/go-git"): 40550,
            (41507, "src-d/go-git"): 40550,
            (41496, "src-d/go-git"): 40550,
            (41495, "src-d/go-git"): 40550,
            (41500, "src-d/go-git"): 40550,
            (41499, "src-d/go-git"): 40550,
            (41498, "src-d/go-git"): 40550,
            (41497, "src-d/go-git"): 40550,
            (41490, "src-d/go-git"): 40550,
            (41488, "src-d/go-git"): 40550,
            (41487, "src-d/go-git"): 40550,
            (41486, "src-d/go-git"): 40550,
            (41494, "src-d/go-git"): 40550,
            (41493, "src-d/go-git"): 40550,
            (41492, "src-d/go-git"): 40550,
            (41491, "src-d/go-git"): 40550,
        },
        "published_at": {
            (41475, "src-d/go-git"): np.datetime64("2019-08-01 15:25:42", "us"),
            (41474, "src-d/go-git"): np.datetime64("2019-07-31 13:41:28", "us"),
            (41473, "src-d/go-git"): np.datetime64("2019-06-18 22:57:34", "us"),
            (41472, "src-d/go-git"): np.datetime64("2019-04-18 10:57:14", "us"),
            (41471, "src-d/go-git"): np.datetime64("2019-02-14 11:54:17", "us"),
            (41470, "src-d/go-git"): np.datetime64("2019-01-30 18:13:24", "us"),
            (41469, "src-d/go-git"): np.datetime64("2019-01-30 10:04:07", "us"),
            (41468, "src-d/go-git"): np.datetime64("2018-11-27 15:23:58", "us"),
            (41467, "src-d/go-git"): np.datetime64("2018-11-19 22:36:14", "us"),
            (41485, "src-d/go-git"): np.datetime64("2018-10-16 09:47:12", "us"),
            (41484, "src-d/go-git"): np.datetime64("2018-09-07 07:05:59", "us"),
            (41483, "src-d/go-git"): np.datetime64("2018-08-17 10:21:31", "us"),
            (41482, "src-d/go-git"): np.datetime64("2018-07-10 09:57:30", "us"),
            (41481, "src-d/go-git"): np.datetime64("2018-06-08 07:40:24", "us"),
            (41480, "src-d/go-git"): np.datetime64("2018-05-16 10:34:04", "us"),
            (41479, "src-d/go-git"): np.datetime64("2018-04-17 13:35:43", "us"),
            (41478, "src-d/go-git"): np.datetime64("2018-04-11 08:31:43", "us"),
            (41477, "src-d/go-git"): np.datetime64("2018-04-03 08:06:55", "us"),
            (41476, "src-d/go-git"): np.datetime64("2018-03-12 10:30:30", "us"),
            (41517, "src-d/go-git"): np.datetime64("2018-02-17 12:20:16", "us"),
            (41519, "src-d/go-git"): np.datetime64("2018-01-16 13:42:33", "us"),
            (41518, "src-d/go-git"): np.datetime64("2018-01-08 13:07:18", "us"),
            (41514, "src-d/go-git"): np.datetime64("2017-09-04 17:54:50", "us"),
            (41513, "src-d/go-git"): np.datetime64("2017-08-28 19:17:48", "us"),
            (41516, "src-d/go-git"): np.datetime64("2017-07-28 20:04:14", "us"),
            (41515, "src-d/go-git"): np.datetime64("2017-07-17 08:01:15", "us"),
            (41512, "src-d/go-git"): np.datetime64("2017-06-22 22:17:22", "us"),
            (41511, "src-d/go-git"): np.datetime64("2017-05-24 10:12:48", "us"),
            (41510, "src-d/go-git"): np.datetime64("2017-02-01 09:51:10", "us"),
            (41509, "src-d/go-git"): np.datetime64("2017-01-31 10:02:46", "us"),
            (41508, "src-d/go-git"): np.datetime64("2017-01-19 13:33:33", "us"),
            (41506, "src-d/go-git"): np.datetime64("2016-12-19 17:39:45", "us"),
            (41505, "src-d/go-git"): np.datetime64("2016-12-16 21:54:14", "us"),
            (41503, "src-d/go-git"): np.datetime64("2016-11-14 21:15:45", "us"),
            (41502, "src-d/go-git"): np.datetime64("2016-11-07 11:03:02", "us"),
            (41501, "src-d/go-git"): np.datetime64("2016-11-04 15:24:48", "us"),
            (41507, "src-d/go-git"): np.datetime64("2016-09-27 10:43:35", "us"),
            (41496, "src-d/go-git"): np.datetime64("2016-08-02 08:59:10", "us"),
            (41495, "src-d/go-git"): np.datetime64("2016-07-05 12:30:47", "us"),
            (41500, "src-d/go-git"): np.datetime64("2016-05-19 11:35:00", "us"),
            (41499, "src-d/go-git"): np.datetime64("2016-05-10 12:17:28", "us"),
            (41498, "src-d/go-git"): np.datetime64("2016-04-25 07:24:50", "us"),
            (41497, "src-d/go-git"): np.datetime64("2016-04-22 09:37:44", "us"),
            (41490, "src-d/go-git"): np.datetime64("2016-02-24 00:03:05", "us"),
            (41488, "src-d/go-git"): np.datetime64("2016-02-16 16:39:02", "us"),
            (41487, "src-d/go-git"): np.datetime64("2016-01-27 11:08:21", "us"),
            (41486, "src-d/go-git"): np.datetime64("2016-01-11 11:26:28", "us"),
            (41494, "src-d/go-git"): np.datetime64("2016-01-08 16:02:13", "us"),
            (41493, "src-d/go-git"): np.datetime64("2016-01-07 15:05:01", "us"),
            (41492, "src-d/go-git"): np.datetime64("2015-12-13 00:14:45", "us"),
            (41491, "src-d/go-git"): np.datetime64("2015-10-22 11:13:09", "us"),
        },
        "sha": {
            (41475, "src-d/go-git"): b"0d1a009cbb604db18be960db5f1525b99a55d727",
            (41474, "src-d/go-git"): b"6241d0e70427cb0db4ca00182717af88f638268c",
            (41473, "src-d/go-git"): b"f9a30199e7083bdda8adad3a4fa2ec42d25c1fdb",
            (41472, "src-d/go-git"): b"aa6f288c256ff8baf8a7745546a9752323dc0d89",
            (41471, "src-d/go-git"): b"db6c41c156481962abf9a55a324858674c25ab08",
            (41470, "src-d/go-git"): b"a1f6ef44dfed1253ef7f3bc049f66b15f8fc2ab2",
            (41469, "src-d/go-git"): b"434611b74cb54538088c6aeed4ed27d3044064fa",
            (41468, "src-d/go-git"): b"3dbfb89e0f5bce0008724e547b999fe3af9f60db",
            (41467, "src-d/go-git"): b"f62cd8e3495579a8323455fa0c4e6c44bb0d5e09",
            (41485, "src-d/go-git"): b"cd64b4d630b6c2d2b3d72e9615e14f9d58bb5787",
            (41484, "src-d/go-git"): b"d3cec13ac0b195bfb897ed038a08b5130ab9969e",
            (41483, "src-d/go-git"): b"7b6c1266556f59ac436fada3fa6106d4a84f9b56",
            (41482, "src-d/go-git"): b"3bd5e82b2512d85becae9677fa06b5a973fd4cfb",
            (41481, "src-d/go-git"): b"b23570073eaee3489e5e3d666f22ba5cbeb53243",
            (41480, "src-d/go-git"): b"57570e84f8c5739f0f4a59387493e590e709dde9",
            (41479, "src-d/go-git"): b"b30763cb64afa91c016b23e905af0a378eb1b76d",
            (41478, "src-d/go-git"): b"0db54e829f81a28f71c22d54c03daba5ec144c8d",
            (41477, "src-d/go-git"): b"247cf690745dfd67ccd9f0c07878e6dd85e6c9ed",
            (41476, "src-d/go-git"): b"1d28459504251497e0ce6132a0fadd5eb44ffd22",
            (41517, "src-d/go-git"): b"886dc83f3ed518a78772055497bcc7d7621b468e",
            (41519, "src-d/go-git"): b"e9247ce9c5ce12126f646ca3ddf0066e4829bd14",
            (41518, "src-d/go-git"): b"bf3b1f1fb9e0a04d0f87511a7ded2562b48a19d8",
            (41514, "src-d/go-git"): b"f9879dd043f84936a1f8acb8a53b74332a7ae135",
            (41513, "src-d/go-git"): b"7aa9d15d395282144f31a09c0fac230da3f65360",
            (41516, "src-d/go-git"): b"8ddbecf782c2e340fd85bb4ba4d00dc73d749f87",
            (41515, "src-d/go-git"): b"d3c7400c39f86a4c59340c7a9cda8497186e00fc",
            (41512, "src-d/go-git"): b"ad02bf020460c210660db4fffda7f926b6aae95a",
            (41511, "src-d/go-git"): b"7e249dfcf28765939bde8f38784b3274b522f880",
            (41510, "src-d/go-git"): b"a9920b123ba1f6819a8c03209582d4d28e9fd831",
            (41509, "src-d/go-git"): b"f84e3bbfe59f5438c90000e6a89b41ec8eab51fb",
            (41508, "src-d/go-git"): b"441713897ef5604e8105379f45ebb982ab2c9a75",
            (41506, "src-d/go-git"): b"e42e10f112ec93fbca3d972dffa9566b94a0f6f8",
            (41505, "src-d/go-git"): b"c9353b2bd7c1cbdf8f78dad6deac64ed2f2ed9eb",
            (41503, "src-d/go-git"): b"eb89d2dd9a36440d58aea224c055b364e49785f7",
            (41502, "src-d/go-git"): b"f6ed7424cbf33c7013332d7e95b4262a4bc4a523",
            (41501, "src-d/go-git"): b"743989abd8c1277dff78e56c2583a9f6dff796ff",
            (41507, "src-d/go-git"): b"8cd772a53e8ecd2687b739eea110fa9b179f1e0f",
            (41496, "src-d/go-git"): b"5413c7aeadb7cb18a6d51dae0bc313f2e129a337",
            (41495, "src-d/go-git"): b"5e73f01cb2e027a8f02801635b79d3a9bc866914",
            (41500, "src-d/go-git"): b"08f9e7015aad2ca768638b446fb8632f11601899",
            (41499, "src-d/go-git"): b"1cd347ec8970388f83745c9a530ea2bcd705c6d9",
            (41498, "src-d/go-git"): b"36d14454b32eca89ac43d2934c50f3a1ae2e1d20",
            (41497, "src-d/go-git"): b"b08327bfaf27171dddc5516c63e5646c40f0b004",
            (41490, "src-d/go-git"): b"07ca1ac7f3058ea6d3274a01973541fb84782f5e",
            (41488, "src-d/go-git"): b"1931dfbf38508e790e9f129873bc073aacc6a50f",
            (41487, "src-d/go-git"): b"35ee4d749be21691b78a7465361ad47179fe2eff",
            (41486, "src-d/go-git"): b"37cc5cf842c3c0fb989bcf7525cc8f826d96b295",
            (41494, "src-d/go-git"): b"cebec78608e7913b8c843390237fd609069022ae",
            (41493, "src-d/go-git"): b"da5ab9de3e4c1bffa533108f46c5adc30929f7c2",
            (41492, "src-d/go-git"): b"f821e1340752dce95f73375dc9a13dcd58d58f82",
            (41491, "src-d/go-git"): b"6f43e8933ba3c04072d5d104acc6118aac3e52ee",
        },
        "commit_id": {
            (41475, "src-d/go-git"): 2755244,
            (41474, "src-d/go-git"): 2756276,
            (41473, "src-d/go-git"): 2758155,
            (41472, "src-d/go-git"): 2757229,
            (41471, "src-d/go-git"): 2757785,
            (41470, "src-d/go-git"): 2757112,
            (41469, "src-d/go-git"): 2755886,
            (41468, "src-d/go-git"): 2755046,
            (41467, "src-d/go-git"): 2758121,
            (41485, "src-d/go-git"): 2757058,
            (41484, "src-d/go-git"): 2757690,
            (41483, "src-d/go-git"): 2755789,
            (41482, "src-d/go-git"): 2755028,
            (41481, "src-d/go-git"): 2757357,
            (41480, "src-d/go-git"): 2756138,
            (41479, "src-d/go-git"): 2757371,
            (41478, "src-d/go-git"): 2755246,
            (41477, "src-d/go-git"): 2755522,
            (41476, "src-d/go-git"): 2755428,
            (41517, "src-d/go-git"): 2756702,
            (41519, "src-d/go-git"): 2757970,
            (41518, "src-d/go-git"): 2757510,
            (41514, "src-d/go-git"): 2758150,
            (41513, "src-d/go-git"): 2755784,
            (41516, "src-d/go-git"): 2756777,
            (41515, "src-d/go-git"): 2757689,
            (41512, "src-d/go-git"): 2757276,
            (41511, "src-d/go-git"): 2755834,
            (41510, "src-d/go-git"): 2757219,
            (41509, "src-d/go-git"): 2758137,
            (41508, "src-d/go-git"): 2755902,
            (41506, "src-d/go-git"): 2757904,
            (41505, "src-d/go-git"): 2757629,
            (41503, "src-d/go-git"): 2757988,
            (41502, "src-d/go-git"): 2758123,
            (41501, "src-d/go-git"): 2756516,
            (41507, "src-d/go-git"): 2756766,
            (41496, "src-d/go-git"): 2756112,
            (41495, "src-d/go-git"): 2756224,
            (41500, "src-d/go-git"): 2755176,
            (41499, "src-d/go-git"): 2755419,
            (41498, "src-d/go-git"): 2755730,
            (41497, "src-d/go-git"): 2757320,
            (41490, "src-d/go-git"): 2755165,
            (41488, "src-d/go-git"): 2755383,
            (41487, "src-d/go-git"): 2755718,
            (41486, "src-d/go-git"): 2755745,
            (41494, "src-d/go-git"): 2757079,
            (41493, "src-d/go-git"): 2757770,
            (41492, "src-d/go-git"): 2758144,
            (41491, "src-d/go-git"): 2756452,
        },
        "author_node_id": {
            (41475, "src-d/go-git"): 39789,
            (41474, "src-d/go-git"): 39789,
            (41473, "src-d/go-git"): 39789,
            (41472, "src-d/go-git"): 39789,
            (41471, "src-d/go-git"): 39789,
            (41470, "src-d/go-git"): 39789,
            (41469, "src-d/go-git"): 39789,
            (41468, "src-d/go-git"): 39789,
            (41467, "src-d/go-git"): 39789,
            (41485, "src-d/go-git"): 39789,
            (41484, "src-d/go-git"): 39789,
            (41483, "src-d/go-git"): 0,
            (41482, "src-d/go-git"): 39789,
            (41481, "src-d/go-git"): 39789,
            (41480, "src-d/go-git"): 39789,
            (41479, "src-d/go-git"): 39789,
            (41478, "src-d/go-git"): 39789,
            (41477, "src-d/go-git"): 39789,
            (41476, "src-d/go-git"): 39789,
            (41517, "src-d/go-git"): 39789,
            (41519, "src-d/go-git"): 39789,
            (41518, "src-d/go-git"): 39789,
            (41514, "src-d/go-git"): 39789,
            (41513, "src-d/go-git"): 39789,
            (41516, "src-d/go-git"): 39789,
            (41515, "src-d/go-git"): 39789,
            (41512, "src-d/go-git"): 39789,
            (41511, "src-d/go-git"): 40070,
            (41510, "src-d/go-git"): 39789,
            (41509, "src-d/go-git"): 39789,
            (41508, "src-d/go-git"): 40070,
            (41506, "src-d/go-git"): 40070,
            (41505, "src-d/go-git"): 39789,
            (41503, "src-d/go-git"): 39789,
            (41502, "src-d/go-git"): 40070,
            (41501, "src-d/go-git"): 40070,
            (41507, "src-d/go-git"): 39789,
            (41496, "src-d/go-git"): 39789,
            (41495, "src-d/go-git"): 40418,
            (41500, "src-d/go-git"): 39789,
            (41499, "src-d/go-git"): 39789,
            (41498, "src-d/go-git"): 39789,
            (41497, "src-d/go-git"): 39789,
            (41490, "src-d/go-git"): 39789,
            (41488, "src-d/go-git"): 39789,
            (41487, "src-d/go-git"): 39789,
            (41486, "src-d/go-git"): 39789,
            (41494, "src-d/go-git"): 39789,
            (41493, "src-d/go-git"): 39789,
            (41492, "src-d/go-git"): 39789,
            (41491, "src-d/go-git"): 39789,
        },
        "name": {
            (41475, "src-d/go-git"): "v4.13.1",
            (41474, "src-d/go-git"): "v4.13.0",
            (41473, "src-d/go-git"): "v4.12.0",
            (41472, "src-d/go-git"): "v4.11.0",
            (41471, "src-d/go-git"): "v4.10.0",
            (41470, "src-d/go-git"): "v4.9.1",
            (41469, "src-d/go-git"): "v4.9.0",
            (41468, "src-d/go-git"): "v4.8.1",
            (41467, "src-d/go-git"): "v4.8.0",
            (41485, "src-d/go-git"): "v4.7.1",
            (41484, "src-d/go-git"): "v4.7.0",
            (41483, "src-d/go-git"): "v4.6.0",
            (41482, "src-d/go-git"): "v4.5.0",
            (41481, "src-d/go-git"): "v4.4.1",
            (41480, "src-d/go-git"): "v4.4.0",
            (41479, "src-d/go-git"): "v4.3.1",
            (41478, "src-d/go-git"): "v4.3.0",
            (41477, "src-d/go-git"): "v4.2.1",
            (41476, "src-d/go-git"): "v4.2.0",
            (41517, "src-d/go-git"): "v4.1.1",
            (41519, "src-d/go-git"): "v4.1.0",
            (41518, "src-d/go-git"): "v4.0.0",
            (41514, "src-d/go-git"): "v4.0.0-rc15",
            (41513, "src-d/go-git"): "v4.0.0-rc14",
            (41516, "src-d/go-git"): "v4.0.0-rc13",
            (41515, "src-d/go-git"): "v4.0.0-rc12",
            (41512, "src-d/go-git"): "v4.0.0-rc11",
            (41511, "src-d/go-git"): "v4.0.0-rc10",
            (41510, "src-d/go-git"): "v4.0.0-rc9",
            (41509, "src-d/go-git"): "v4.0.0-rc8",
            (41508, "src-d/go-git"): "v4.0.0-rc7",
            (41506, "src-d/go-git"): "v4.0.0-rc6",
            (41505, "src-d/go-git"): "v4.0.0-rc5",
            (41503, "src-d/go-git"): "v4.0.0-rc4",
            (41502, "src-d/go-git"): "v4.0.0-rc3",
            (41501, "src-d/go-git"): "v4.0.0-rc2",
            (41507, "src-d/go-git"): "v4.0.0-rc1",
            (41496, "src-d/go-git"): "v3.1.1",
            (41495, "src-d/go-git"): "v3.1.0",
            (41500, "src-d/go-git"): "v3.0.4",
            (41499, "src-d/go-git"): "v3.0.3",
            (41498, "src-d/go-git"): "v3.0.2",
            (41497, "src-d/go-git"): "v3.0.1",
            (41490, "src-d/go-git"): "v3.0.0-alpha",
            (41488, "src-d/go-git"): "v2.2.0",
            (41487, "src-d/go-git"): "v2.1.3",
            (41486, "src-d/go-git"): "v2.1.2 hotfix",
            (41494, "src-d/go-git"): "v2.1.1 hotfix",
            (41493, "src-d/go-git"): "v2.1.0",
            (41492, "src-d/go-git"): "v2.0.0",
            (41491, "src-d/go-git"): "v1.0.0",
        },
        "tag": {
            (41475, "src-d/go-git"): "v4.13.1",
            (41474, "src-d/go-git"): "v4.13.0",
            (41473, "src-d/go-git"): "v4.12.0",
            (41472, "src-d/go-git"): "v4.11.0",
            (41471, "src-d/go-git"): "v4.10.0",
            (41470, "src-d/go-git"): "v4.9.1",
            (41469, "src-d/go-git"): "v4.9.0",
            (41468, "src-d/go-git"): "v4.8.1",
            (41467, "src-d/go-git"): "v4.8.0",
            (41485, "src-d/go-git"): "v4.7.1",
            (41484, "src-d/go-git"): "v4.7.0",
            (41483, "src-d/go-git"): "v4.6.0",
            (41482, "src-d/go-git"): "v4.5.0",
            (41481, "src-d/go-git"): "v4.4.1",
            (41480, "src-d/go-git"): "v4.4.0",
            (41479, "src-d/go-git"): "v4.3.1",
            (41478, "src-d/go-git"): "v4.3.0",
            (41477, "src-d/go-git"): "v4.2.1",
            (41476, "src-d/go-git"): "v4.2.0",
            (41517, "src-d/go-git"): "v4.1.1",
            (41519, "src-d/go-git"): "v4.1.0",
            (41518, "src-d/go-git"): "v4.0.0",
            (41514, "src-d/go-git"): "v4.0.0-rc15",
            (41513, "src-d/go-git"): "v4.0.0-rc14",
            (41516, "src-d/go-git"): "v4.0.0-rc13",
            (41515, "src-d/go-git"): "v4.0.0-rc12",
            (41512, "src-d/go-git"): "v4.0.0-rc11",
            (41511, "src-d/go-git"): "v4.0.0-rc10",
            (41510, "src-d/go-git"): "v4.0.0-rc9",
            (41509, "src-d/go-git"): "v4.0.0-rc8",
            (41508, "src-d/go-git"): "v4.0.0-rc7",
            (41506, "src-d/go-git"): "v4.0.0-rc6",
            (41505, "src-d/go-git"): "v4.0.0-rc5",
            (41503, "src-d/go-git"): "v4.0.0-rc4",
            (41502, "src-d/go-git"): "v4.0.0-rc3",
            (41501, "src-d/go-git"): "v4.0.0-rc2",
            (41507, "src-d/go-git"): "v4.0.0-rc1",
            (41496, "src-d/go-git"): "v3.1.1",
            (41495, "src-d/go-git"): "v3.1.0",
            (41500, "src-d/go-git"): "v3.0.4",
            (41499, "src-d/go-git"): "v3.0.3",
            (41498, "src-d/go-git"): "v3.0.2",
            (41497, "src-d/go-git"): "v3.0.1",
            (41490, "src-d/go-git"): "v3.0.0",
            (41488, "src-d/go-git"): "v2.2.0",
            (41487, "src-d/go-git"): "v2.1.3",
            (41486, "src-d/go-git"): "v2.1.2",
            (41494, "src-d/go-git"): "v2.1.1",
            (41493, "src-d/go-git"): "v2.1.0",
            (41492, "src-d/go-git"): "v2.0.0",
            (41491, "src-d/go-git"): "v1.0.0",
        },
        "url": {
            (41475, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.13.1",
            (41474, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.13.0",
            (41473, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.12.0",
            (41472, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.11.0",
            (41471, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.10.0",
            (41470, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.9.1",
            (41469, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.9.0",
            (41468, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.8.1",
            (41467, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.8.0",
            (41485, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.7.1",
            (41484, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.7.0",
            (41483, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.6.0",
            (41482, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.5.0",
            (41481, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.4.1",
            (41480, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.4.0",
            (41479, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.3.1",
            (41478, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.3.0",
            (41477, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.2.1",
            (41476, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.2.0",
            (41517, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.1.1",
            (41519, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.1.0",
            (41518, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0",
            (41514, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc15",
            (41513, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc14",
            (41516, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc13",
            (41515, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc12",
            (41512, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc11",
            (41511, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc10",
            (41510, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc9",
            (41509, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc8",
            (41508, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc7",
            (41506, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc6",
            (41505, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc5",
            (41503, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc4",
            (41502, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc3",
            (41501, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc2",
            (41507, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v4.0.0-rc1",
            (41496, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v3.1.1",
            (41495, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v3.1.0",
            (41500, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v3.0.4",
            (41499, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v3.0.3",
            (41498, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v3.0.2",
            (41497, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v3.0.1",
            (41490, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v3.0.0",
            (41488, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v2.2.0",
            (41487, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v2.1.3",
            (41486, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v2.1.2",
            (41494, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v2.1.1",
            (41493, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v2.1.0",
            (41492, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v2.0.0",
            (41491, "src-d/go-git"): "https://github.com/src-d/go-git/releases/tag/v1.0.0",
        },
        "matched_by": {
            (41475, "src-d/go-git"): 1,
            (41474, "src-d/go-git"): 1,
            (41473, "src-d/go-git"): 1,
            (41472, "src-d/go-git"): 1,
            (41471, "src-d/go-git"): 1,
            (41470, "src-d/go-git"): 1,
            (41469, "src-d/go-git"): 1,
            (41468, "src-d/go-git"): 1,
            (41467, "src-d/go-git"): 1,
            (41485, "src-d/go-git"): 1,
            (41484, "src-d/go-git"): 1,
            (41483, "src-d/go-git"): 1,
            (41482, "src-d/go-git"): 1,
            (41481, "src-d/go-git"): 1,
            (41480, "src-d/go-git"): 1,
            (41479, "src-d/go-git"): 1,
            (41478, "src-d/go-git"): 1,
            (41477, "src-d/go-git"): 1,
            (41476, "src-d/go-git"): 1,
            (41517, "src-d/go-git"): 1,
            (41519, "src-d/go-git"): 1,
            (41518, "src-d/go-git"): 1,
            (41514, "src-d/go-git"): 1,
            (41513, "src-d/go-git"): 1,
            (41516, "src-d/go-git"): 1,
            (41515, "src-d/go-git"): 1,
            (41512, "src-d/go-git"): 1,
            (41511, "src-d/go-git"): 1,
            (41510, "src-d/go-git"): 1,
            (41509, "src-d/go-git"): 1,
            (41508, "src-d/go-git"): 1,
            (41506, "src-d/go-git"): 1,
            (41505, "src-d/go-git"): 1,
            (41503, "src-d/go-git"): 1,
            (41502, "src-d/go-git"): 1,
            (41501, "src-d/go-git"): 1,
            (41507, "src-d/go-git"): 1,
            (41496, "src-d/go-git"): 1,
            (41495, "src-d/go-git"): 1,
            (41500, "src-d/go-git"): 1,
            (41499, "src-d/go-git"): 1,
            (41498, "src-d/go-git"): 1,
            (41497, "src-d/go-git"): 1,
            (41490, "src-d/go-git"): 1,
            (41488, "src-d/go-git"): 1,
            (41487, "src-d/go-git"): 1,
            (41486, "src-d/go-git"): 1,
            (41494, "src-d/go-git"): 1,
            (41493, "src-d/go-git"): 1,
            (41492, "src-d/go-git"): 1,
            (41491, "src-d/go-git"): 1,
        },
        "author": {
            (41475, "src-d/go-git"): "mcuadros",
            (41474, "src-d/go-git"): "mcuadros",
            (41473, "src-d/go-git"): "mcuadros",
            (41472, "src-d/go-git"): "mcuadros",
            (41471, "src-d/go-git"): "mcuadros",
            (41470, "src-d/go-git"): "mcuadros",
            (41469, "src-d/go-git"): "mcuadros",
            (41468, "src-d/go-git"): "mcuadros",
            (41467, "src-d/go-git"): "mcuadros",
            (41485, "src-d/go-git"): "mcuadros",
            (41484, "src-d/go-git"): "mcuadros",
            (41483, "src-d/go-git"): None,
            (41482, "src-d/go-git"): "mcuadros",
            (41481, "src-d/go-git"): "mcuadros",
            (41480, "src-d/go-git"): "mcuadros",
            (41479, "src-d/go-git"): "mcuadros",
            (41478, "src-d/go-git"): "mcuadros",
            (41477, "src-d/go-git"): "mcuadros",
            (41476, "src-d/go-git"): "mcuadros",
            (41517, "src-d/go-git"): "mcuadros",
            (41519, "src-d/go-git"): "mcuadros",
            (41518, "src-d/go-git"): "mcuadros",
            (41514, "src-d/go-git"): "mcuadros",
            (41513, "src-d/go-git"): "mcuadros",
            (41516, "src-d/go-git"): "mcuadros",
            (41515, "src-d/go-git"): "mcuadros",
            (41512, "src-d/go-git"): "mcuadros",
            (41511, "src-d/go-git"): "smola",
            (41510, "src-d/go-git"): "mcuadros",
            (41509, "src-d/go-git"): "mcuadros",
            (41508, "src-d/go-git"): "smola",
            (41506, "src-d/go-git"): "smola",
            (41505, "src-d/go-git"): "mcuadros",
            (41503, "src-d/go-git"): "mcuadros",
            (41502, "src-d/go-git"): "smola",
            (41501, "src-d/go-git"): "smola",
            (41507, "src-d/go-git"): "mcuadros",
            (41496, "src-d/go-git"): "mcuadros",
            (41495, "src-d/go-git"): "alcortesm",
            (41500, "src-d/go-git"): "mcuadros",
            (41499, "src-d/go-git"): "mcuadros",
            (41498, "src-d/go-git"): "mcuadros",
            (41497, "src-d/go-git"): "mcuadros",
            (41490, "src-d/go-git"): "mcuadros",
            (41488, "src-d/go-git"): "mcuadros",
            (41487, "src-d/go-git"): "mcuadros",
            (41486, "src-d/go-git"): "mcuadros",
            (41494, "src-d/go-git"): "mcuadros",
            (41493, "src-d/go-git"): "mcuadros",
            (41492, "src-d/go-git"): "mcuadros",
            (41491, "src-d/go-git"): "mcuadros",
        },
    }
    for topic, values in ground_truth.items():
        assert obj[topic] == values, topic
    diff_keys = obj.keys() - ground_truth.keys()
    assert not diff_keys


@with_defer
async def test_mine_deployments_precomputed_dummy(
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
):
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    deps1 = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
    )
    people1 = deployment_facts_extract_mentioned_people(deps1)
    await wait_deferred()
    deps2 = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
    )
    people2 = deployment_facts_extract_mentioned_people(deps2)
    assert len(deps1) == len(deps2) == 1
    assert_index_equal(deps1.index, deps2.index)
    for topic in ("releases", "components", "labels"):
        for pdf, sdf in zip(deps1[topic], deps2[topic]):
            assert_frame_equal(pdf, sdf)
    for df in (deps1, deps2):
        for col in ("releases", "components", "labels"):
            del df[col]
    assert_frame_equal(deps1, deps2)
    assert (people1 == people2).all()


@with_defer
async def test_mine_deployments_precomputed_sample(
    sample_deployments,
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
):
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    deps1 = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        eager_filter_repositories=False,
    )
    people1 = deployment_facts_extract_mentioned_people(deps1)
    await wait_deferred()
    deps2 = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        eager_filter_repositories=False,
    )
    people2 = deployment_facts_extract_mentioned_people(deps2)
    assert len(deps1) == len(deps2) == 2 * 9
    assert_index_equal(deps1.index, deps2.index)
    lensum = 0
    for i in range(18):
        assert (rel1 := deps1["releases"][i]).columns == (rel2 := deps2["releases"][i]).columns, i
        assert len(rel1) == len(rel2)
        for il1, il2 in zip(rel1.index.levels(), rel2.index.levels()):
            assert_array_equal(il1, il2)
        lensum += len(rel1)
    assert lensum == 68 * 2
    for topic in ("components", "labels"):
        for pdf, sdf in zip(deps1[topic], deps2[topic]):
            assert_frame_equal(pdf, sdf)
    for df in (deps1, deps2):
        for col in ("releases", "components", "labels"):
            del df[col]
    assert_frame_equal(deps1, deps2)
    assert (people1 == people2).all()


@with_defer
async def test_mine_deployments_reversed(
    sample_deployments,
    release_match_setting_tag,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
):
    time_from = datetime(2018, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    deps1 = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        eager_filter_repositories=False,
    )
    deployment_facts_extract_mentioned_people(deps1)
    await wait_deferred()

    name = "%s_%d_%02d_%02d" % ("production", 2019, 12, 1)
    await rdb.execute(
        insert(DeploymentNotification).values(
            account_id=1,
            name=name,
            conclusion="SUCCESS",
            environment="production",
            started_at=datetime(2019, 12, 1, tzinfo=timezone.utc),
            finished_at=datetime(2019, 12, 1, 0, 10, tzinfo=timezone.utc),
            created_at=datetime.now(timezone.utc),
            updated_at=datetime.now(timezone.utc),
        ),
    )
    await rdb.execute(
        insert(DeployedComponent).values(
            account_id=1,
            deployment_name=name,
            repository_node_id=40550,
            reference="v4.13.0",
            resolved_commit_node_id=2756276,
            created_at=datetime.now(timezone.utc),
        ),
    )

    deps2 = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        eager_filter_repositories=False,
    )
    deployment_facts_extract_mentioned_people(deps2)
    assert len(deps2) == len(deps1) + 1
    assert set(deps1.index.values) == set(deps2.index.values) - {"production_2019_12_01"}
    i = np.flatnonzero(deps2.index.values == "production_2019_12_01")[0]
    assert deps2.iloc[i][DeploymentFacts.f.commits_overall][0] == 0
    assert deps2.iloc[i][DeploymentFacts.f.commits_prs][0] == 0
    assert len(deps2.iloc[i][DeploymentFacts.f.prs]) == 0


@with_defer
async def test_mine_deployments_empty(
    release_match_setting_tag_or_branch,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
):
    await rdb.execute(delete(DeployedLabel))
    await rdb.execute(delete(DeployedComponent))
    await rdb.execute(delete(DeploymentNotification))
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [DeploymentConclusion.SUCCESS],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
    )
    assert len(deps) == 0
    await wait_deferred()
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [DeploymentConclusion.SUCCESS],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        None,
        None,
        None,
        cache,
    )
    assert len(deps) == 0


@pytest.mark.parametrize("with_premining", [True, False])
@with_defer
async def test_mine_deployments_event_releases(
    sample_deployments,
    release_match_setting_event,
    branches,
    default_branches,
    prefixer,
    mdb,
    pdb,
    rdb,
    cache,
    with_premining,
):
    with_premining = True
    await rdb.execute(
        insert(ReleaseNotification).values(
            ReleaseNotification(
                account_id=1,
                repository_node_id=40550,
                commit_hash_prefix="1edb992",
                name="Pushed!",
                author_node_id=40020,
                url="www",
                published_at=datetime(2019, 9, 1, tzinfo=timezone.utc),
            )
            .create_defaults()
            .explode(with_primary_keys=True),
        ),
    )
    await rdb.execute(
        insert(ReleaseNotification).values(
            ReleaseNotification(
                account_id=1,
                repository_node_id=40550,
                commit_hash_prefix="0023a4a5d4aba74240e5bbc403e56af349edf66c",
                name="for test",
                author_node_id=40020,
                url="www",
                published_at=datetime(2019, 10, 1, tzinfo=timezone.utc),
            )
            .create_defaults()
            .explode(with_primary_keys=True),
        ),
    )
    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)
    if with_premining:
        await mine_releases(
            ["src-d/go-git"],
            {},
            branches,
            default_branches,
            time_from,
            time_to,
            LabelFilter.empty(),
            JIRAFilter.empty(),
            release_match_setting_event,
            LogicalRepositorySettings.empty(),
            prefixer,
            1,
            (6366825,),
            mdb,
            pdb,
            rdb,
            None,
            with_avatars=False,
            with_extended_pr_details=False,
            with_deployments=False,
        )
        await wait_deferred()
    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "staging"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_event,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        cache,
    )
    deployment_facts_extract_mentioned_people(deps)
    for depname in ("production_2019_11_01", "staging_2019_11_01"):
        df = deps.take(deps.index.get_level_values(0) == depname)["releases"][0]
        assert len(df) == 1
        df = df.iloc[0]
        assert df[Release.name.name] == "Pushed!"
        assert df[Release.sha.name] == b"1edb992dbc419a0767b1cf3a524b0d35529799f5"
        assert len(df[ReleaseFacts.f.commit_authors]) == 113
        assert len(set(df[ReleaseFacts.f.commit_authors])) == 113
        assert len(df[ReleaseFacts.f.prs_node_id]) == 509
        assert len(set(df[ReleaseFacts.f.prs_node_id])) == 509


@pytest.mark.parametrize("old_notifications_mode", ["1", "2", "1-1"])
@with_defer
async def test_invalidate_newer_deploys_smoke(
    branches,
    default_branches,
    release_match_setting_tag_or_branch,
    prefixer,
    mdb,
    pdb,
    rdb,
    old_notifications_mode,
) -> None:
    await rdb.execute(sa.delete(DeploymentNotification))
    await rdb.execute(sa.delete(DeployedComponent))
    await rdb.execute(sa.delete(DeployedLabel))

    time_from = datetime(2015, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 2, 1, tzinfo=timezone.utc)
    mine_releases_ = partial(
        mine_releases,
        ["src-d/go-git"],
        {},
        branches,
        default_branches,
        time_from,
        time_to,
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        with_avatars=False,
        with_extended_pr_details=False,
        with_deployments=False,
    )

    mine_deployments_ = partial(
        mine_deployments,
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
    )
    await models_insert(
        rdb,
        DeploymentNotificationFactory(
            name="deploy_old_1", started_at=dt(2019, 1, 1), finished_at=dt(2019, 1, 1, 0, 10),
        ),
        DeployedComponentFactory(
            deployment_name="deploy_old_1",
            repository_node_id=40550,
            resolved_commit_node_id=2756591,
        ),
    )
    match old_notifications_mode:
        case "2":
            await models_insert(
                rdb,
                DeploymentNotificationFactory(
                    name="deploy_old_2",
                    started_at=dt(2020, 1, 1),
                    finished_at=dt(2020, 1, 1, 0, 10),
                ),
                DeployedComponentFactory(
                    deployment_name="deploy_old_2",
                    repository_node_id=40550,
                    resolved_commit_node_id=2755244,
                ),
            )
        case "1-1":
            await models_insert(
                rdb,
                DeploymentNotificationFactory(
                    name="deploy_old_2",
                    started_at=dt(2017, 1, 1),
                    finished_at=dt(2017, 1, 1, 0, 10),
                ),
                DeployedComponentFactory(
                    deployment_name="deploy_old_2",
                    repository_node_id=40550,
                    resolved_commit_node_id=2755513,
                ),
            )

    await mine_releases_()
    await wait_deferred()
    await mine_deployments_()
    await wait_deferred()

    # the new notification is about an older commit
    await models_insert(
        rdb,
        DeploymentNotificationFactory(
            name="deploy_new", started_at=dt(2018, 8, 1), finished_at=dt(2018, 8, 1, 0, 10),
        ),
        DeployedComponentFactory(
            deployment_name="deploy_new",
            repository_node_id=40550,
            resolved_commit_node_id=2755028,
        ),
    )
    deps = await mine_deployments_()
    deploy_new_prs_post = deps[DeploymentFacts.f.prs][
        deps[DeploymentFacts.f.name] == "deploy_new"
    ][0]
    deploy_old1_prs_post = deps[DeploymentFacts.f.prs][
        deps[DeploymentFacts.f.name] == "deploy_old_1"
    ][0]

    # the two deployments must not share any PR
    assert len(deploy_new_prs_post)
    assert len(deploy_old1_prs_post)
    common = set(deploy_new_prs_post) & set(deploy_old1_prs_post)
    assert not common

    if old_notifications_mode != "1":
        deploy_old2_prs_post = deps[DeploymentFacts.f.prs][
            deps[DeploymentFacts.f.name] == "deploy_old_2"
        ][0]
        assert len(deploy_old2_prs_post)
        common = set(deploy_new_prs_post) & set(deploy_old2_prs_post)
        assert not common
        common = set(deploy_old1_prs_post) & set(deploy_old2_prs_post)
        assert not common


@with_defer
async def test_invalidate_newer_deploys_in_pdb_different_envs(
    branches,
    default_branches,
    release_match_setting_tag_or_branch,
    prefixer,
    mdb,
    pdb,
    rdb,
):
    await rdb.execute(sa.delete(DeploymentNotification))
    await rdb.execute(sa.delete(DeployedComponent))
    await rdb.execute(sa.delete(DeployedLabel))

    time_from = datetime(2017, 1, 1, tzinfo=timezone.utc)
    time_to = datetime(2020, 1, 1, tzinfo=timezone.utc)

    await models_insert(
        rdb,
        DeploymentNotificationFactory(
            name="deploy-prod",
            environment="production",
            started_at=dt(2019, 11, 1),
            finished_at=dt(2019, 11, 1, 0, 10),
        ),
        DeployedComponentFactory(
            deployment_name="deploy-prod",
            repository_node_id=40550,
            resolved_commit_node_id=2755244,
        ),
        DeploymentNotificationFactory(
            name="deploy-stage",
            environment="stage",
            started_at=dt(2018, 8, 1),
            finished_at=dt(2018, 8, 1, 0, 10),
        ),
        DeployedComponentFactory(
            deployment_name="deploy-stage",
            repository_node_id=40550,
            resolved_commit_node_id=2755028,
        ),
    )

    await mine_releases(
        ["src-d/go-git"],
        {},
        branches,
        default_branches,
        time_from,
        time_to,
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        with_avatars=False,
        with_extended_pr_details=False,
        with_deployments=False,
    )

    await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
    )
    await wait_deferred()

    deps = await mine_deployments(
        ["src-d/go-git"],
        {},
        time_from,
        time_to,
        ["production", "stage"],
        [],
        {},
        {},
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        branches,
        default_branches,
        prefixer,
        1,
        None,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
    )
    assert sorted(deps.index.values) == ["deploy-prod", "deploy-stage"]


async def _validate_deployed_prs(pdb: morcilla.Database) -> None:
    rows = await pdb.fetch_all(
        select(GitHubPullRequestDeployment.pull_request_id)
        .where(
            GitHubPullRequestDeployment.deployment_name.like("production_%"),
            GitHubPullRequestDeployment.deployment_name.notin_(
                ["production_2018_01_10", "production_2018_01_12"],
            ),
        )
        .group_by(GitHubPullRequestDeployment.pull_request_id)
        .having(func.count(GitHubPullRequestDeployment.deployment_name) > 1),
    )
    assert len(rows) == 0, rows


def _validate_deployments(deps, count, with_2016, eager):
    assert len(deps) == count * 2
    for env in ("staging", "production"):
        assert (
            deps["conclusion"][deps.index.get_level_values(0) == f"{env}_2018_01_11"]
            == DeploymentNotification.CONCLUSION_SUCCESS
        )
        if not eager:
            assert (
                deps["conclusion"][deps.index.get_level_values(0) == f"{env}_2018_01_12"]
                == DeploymentNotification.CONCLUSION_FAILURE
            )
    assert (deps["environment"] == "production").sum() == count
    assert (deps["environment"] == "staging").sum() == count
    components = deps["components"]
    for c in components:
        assert len(c) == 1
        assert c.iloc[0]["repository_node_id"] == 40550
        assert c.iloc[0]["resolved_commit_node_id"] > 0
    assert components[deps.index.values == "production_2018_01_11"][0]["reference"] == "4.0.0"
    assert components[deps.index.values == "staging_2018_01_11"][0]["reference"] == "4.0.0"
    commits_overall = deps["commits_overall"]
    if with_2016:
        assert commits_overall[deps.index.values == "production_2016_07_06"] == [168]
        assert commits_overall[deps.index.values == "production_2016_12_01"] == [14]
    assert commits_overall[deps.index.values == "production_2018_01_10"] == [832]
    assert commits_overall[deps.index.values == "production_2018_01_11"] == [832]
    if not eager:
        assert commits_overall[deps.index.values == "production_2018_01_12"] == [0]
    assert commits_overall[deps.index.values == "production_2018_08_01"] == [122]
    assert commits_overall[deps.index.values == "production_2018_12_01"] == [198]
    if not eager:
        assert commits_overall[deps.index.values == "production_2018_12_02"] == [0]
    assert commits_overall[deps.index.values == "production_2019_11_01"] == [176]
    pdeps = deps.take(deps["environment"] == "production").copy()
    releases = pdeps["releases"]
    if with_2016:
        assert set(releases[pdeps.index.values == "production_2016_07_06"][0]["tag"]) == {
            "v2.2.0",
            "v3.1.0",
            "v3.0.3",
            "v3.0.1",
            "v1.0.0",
            "v3.0.2",
            "v3.0.4",
            "v2.1.1",
            "v2.0.0",
            "v3.0.0",
            "v2.1.2",
            "v2.1.3",
            "v2.1.0",
        }
        assert set(releases[pdeps.index.values == "production_2016_12_01"][0]["tag"]) == {
            "v3.2.0",
            "v3.1.1",
        }
    assert set(releases[pdeps.index.values == "production_2018_01_10"][0]["tag"]) == {
        "v4.0.0-rc10",
        "v4.0.0-rc1",
        "v4.0.0-rc6",
        "v4.0.0-rc8",
        "v4.0.0-rc7",
        "v4.0.0-rc9",
        "v4.0.0",
        "v4.0.0-rc13",
        "v4.0.0-rc2",
        "v4.0.0-rc12",
        "v4.0.0-rc14",
        "v4.0.0-rc15",
        "v4.0.0-rc3",
        "v4.0.0-rc5",
        "v4.0.0-rc4",
        "v4.0.0-rc11",
    }
    assert set(releases[pdeps.index.values == "production_2018_01_11"][0]["tag"]) == {
        "v4.0.0-rc10",
        "v4.0.0-rc1",
        "v4.0.0-rc6",
        "v4.0.0-rc8",
        "v4.0.0-rc7",
        "v4.0.0-rc9",
        "v4.0.0",
        "v4.0.0-rc13",
        "v4.0.0-rc2",
        "v4.0.0-rc12",
        "v4.0.0-rc14",
        "v4.0.0-rc15",
        "v4.0.0-rc3",
        "v4.0.0-rc5",
        "v4.0.0-rc4",
        "v4.0.0-rc11",
    }
    if not eager:
        assert len(releases[pdeps.index.values == "production_2018_01_12"][0]) == 0
    assert set(releases[pdeps.index.values == "production_2018_08_01"][0]["tag"]) == {
        "v4.3.1",
        "v4.5.0",
        "v4.4.0",
        "v4.3.0",
        "v4.2.0",
        "v4.4.1",
        "v4.2.1",
        "v4.1.0",
        "v4.1.1",
    }
    assert set(releases[pdeps.index.values == "production_2018_12_01"][0]["tag"]) == {
        "v4.7.1",
        "v4.6.0",
        "v4.8.0",
        "v4.8.1",
        "v4.7.0",
    }
    if not eager:
        assert len(releases[pdeps.index.values == "production_2018_12_02"][0]) == 0
    assert set(releases[pdeps.index.values == "production_2019_11_01"][0]["tag"]) == {
        "v4.13.0",
        "v4.12.0",
        "v4.13.1",
        "v4.9.0",
        "v4.9.1",
        "v4.11.0",
        "v4.10.0",
    }
    pdeps.sort_index(inplace=True)
    pdeps.reset_index(inplace=True, drop=True)
    del pdeps["environment"]
    sdeps = deps.take(deps["environment"] == "staging").copy()
    sdeps.sort_index(inplace=True)
    sdeps.reset_index(inplace=True, drop=True)
    del sdeps["environment"]
    for topic in ("releases", "components", "labels"):
        for pdf, sdf in zip(pdeps[topic], sdeps[topic]):
            assert_frame_equal(pdf, sdf)
    for df in (pdeps, sdeps):
        for col in ("releases", "components", "labels"):
            del df[col]
    assert_frame_equal(pdeps, sdeps)


class TestHideOutlierFirstDeployments:
    @with_defer
    async def test_base(
        self,
        sample_deployments,
        branches,
        prefixer,
        mdb,
        pdb,
        rdb,
        sdb,
    ) -> None:
        meta_ids = await get_metadata_account_ids(1, sdb, None)
        assert (await count(pdb, GitHubDeploymentFacts)) == 0
        assert (await count(pdb, GitHubPullRequestDeployment)) == 0

        deps = await mine_deployments(
            **self._mine_common_kwargs(),
            branches=branches,
            prefixer=prefixer,
            mdb=mdb,
            pdb=pdb,
            rdb=rdb,
        )
        # wait deferred tasks writing to pdb to complete
        await wait_deferred()

        expected_outlier_deployments = ["staging_2016_07_06", "production_2016_07_06"]

        pr_where = GitHubPullRequestDeployment.deployment_name.in_(expected_outlier_deployments)
        pre_hiding_pr_count = await count(pdb, GitHubPullRequestDeployment)
        to_be_removed_pr_count = await count(pdb, GitHubPullRequestDeployment, pr_where)

        commit_where = GitHubCommitDeployment.deployment_name.in_(expected_outlier_deployments)
        pre_hiding_commit_count = await count(pdb, GitHubCommitDeployment)
        to_be_removed_commit_count = await count(pdb, GitHubCommitDeployment, commit_where)

        rel_where = GitHubReleaseDeployment.deployment_name.in_(expected_outlier_deployments)
        pre_hiding_release_count = await count(pdb, GitHubReleaseDeployment)
        to_be_removed_release_count = await count(pdb, GitHubReleaseDeployment, rel_where)

        await hide_outlier_first_deployments(deps, 1, meta_ids, mdb, pdb, 1.1)

        post_hiding_pr_count = await count(pdb, GitHubPullRequestDeployment)
        post_hiding_commit_count = await count(pdb, GitHubCommitDeployment)
        post_hiding_release_count = await count(pdb, GitHubReleaseDeployment)

        assert post_hiding_pr_count == pre_hiding_pr_count - to_be_removed_pr_count
        assert post_hiding_commit_count == pre_hiding_commit_count - to_be_removed_commit_count
        assert post_hiding_release_count == pre_hiding_release_count - to_be_removed_release_count

        assert await count(pdb, GitHubPullRequestDeployment, pr_where) == 0

        depl_where = GitHubDeploymentFacts.deployment_name.in_(expected_outlier_deployments)
        depl_rows = await pdb.fetch_all(sa.select(GitHubDeploymentFacts).where(depl_where))
        for depl_row in depl_rows:
            facts = DeploymentFacts(
                depl_row[GitHubDeploymentFacts.data.name],
                name=depl_row[GitHubDeploymentFacts.deployment_name.name],
            )
            assert not len(facts.prs)

    @with_defer
    async def test_no_deployment_facts(
        self,
        branches,
        prefixer,
        mdb,
        pdb,
        rdb,
        sdb,
    ) -> None:
        meta_ids = await get_metadata_account_ids(1, sdb, None)
        # delete notifications so that mine_deployments will find nothing
        await rdb.execute(sa.delete(DeploymentNotification))

        deps = await mine_deployments(
            **self._mine_common_kwargs(),
            branches=branches,
            prefixer=prefixer,
            mdb=mdb,
            pdb=pdb,
            rdb=rdb,
        )

        assert deps.empty
        # wait deferred tasks writing to pdb to complete
        await wait_deferred()

        assert (await count(pdb, GitHubPullRequestDeployment)) == 0
        assert (await count(pdb, GitHubCommitDeployment)) == 0
        assert (await count(pdb, GitHubReleaseDeployment)) == 0

        await hide_outlier_first_deployments(deps, 1, meta_ids, mdb, pdb, 1.1)

    @with_defer
    async def test_multiple_deployments_same_time(
        self,
        branches,
        prefixer,
        mdb,
        pdb,
        rdb,
        sdb,
    ) -> None:
        meta_ids = await get_metadata_account_ids(1, sdb, None)
        await rdb.execute(sa.delete(DeploymentNotification))
        started_at = dt(2019, 1, 1)
        await models_insert(
            rdb,
            DeploymentNotificationFactory(name="deploy0", started_at=started_at),
            DeploymentNotificationFactory(name="deploy1", started_at=started_at),
            DeployedComponentFactory(deployment_name="deploy0", repository_node_id=40550),
            DeployedComponentFactory(deployment_name="deploy1", repository_node_id=40550),
        )

        deps = await mine_deployments(
            **self._mine_common_kwargs(),
            branches=branches,
            prefixer=prefixer,
            mdb=mdb,
            pdb=pdb,
            rdb=rdb,
            eager_filter_repositories=False,
        )
        await wait_deferred()

        await hide_outlier_first_deployments(deps, 1, meta_ids, mdb, pdb, 1.1)

        await assert_missing_row(pdb, GitHubPullRequestDeployment, deployment_name="deploy0")

    @with_defer
    async def test_logical_deployments(
        self,
        branches,
        prefixer,
        mdb,
        pdb,
        rdb,
        release_match_setting_tag_logical,
    ) -> None:
        logical_settings = LogicalRepositorySettings(
            {"src-d/go-git/alpha": {"title": "alpha-.*"}},
            {"src-d/go-git/alpha": {"title": "alpha-.*"}},
        )

        await rdb.execute(sa.delete(DeploymentNotification))
        await models_insert(
            rdb,
            DeploymentNotificationFactory(name="alpha-0", started_at=dt(2019, 1, 1)),
            DeployedComponentFactory(deployment_name="alpha-0", repository_node_id=40550),
            DeploymentNotificationFactory(name="alpha-1", started_at=dt(2019, 1, 2)),
            DeployedComponentFactory(deployment_name="alpha-1", repository_node_id=40550),
        )
        deps = await mine_deployments(
            **self._mine_common_kwargs(
                logical_settings=logical_settings,
                release_settings=release_match_setting_tag_logical,
                repositories=["src-d/go-git/alpha"],
            ),
            branches=branches,
            prefixer=prefixer,
            mdb=mdb,
            pdb=pdb,
            rdb=rdb,
        )
        await wait_deferred()

        await hide_outlier_first_deployments(deps, 1, (6366825,), mdb, pdb, 1.1)

        await assert_missing_row(pdb, GitHubPullRequestDeployment, deployment_name="alpha-0")

    async def test_handle_unknown_repository(self, mdb, pdb) -> None:
        success = DeploymentNotification.CONCLUSION_SUCCESS
        df = self._mk_deployments_df(
            ("deploy0", "prod", dt(2020, 1, 1), success, ["org/repo"]),
            ("deploy1", "prod", dt(2020, 1, 2), success, ["org/repo"]),
        )
        await hide_outlier_first_deployments(df, 1, (DEFAULT_MD_ACCOUNT_ID,), mdb, pdb, 1.1)

    @classmethod
    def _mk_deployments_df(cls, *rows) -> md.DataFrame:
        df_columns = [
            DeploymentNotification.name.name,
            DeploymentNotification.environment.name,
            DeploymentNotification.started_at.name,
            DeploymentNotification.conclusion.name,
            "repositories",
        ]
        arrays = [[] for _ in df_columns]
        for r in rows:
            for i, v in enumerate(r):
                if i == 2:
                    v = v.replace(tzinfo=None)
                arrays[i].append(v)
        repos = np.empty(len(rows), object)
        repos[:] = arrays[-1]
        arrays[-1] = repos
        return md.DataFrame(dict(zip(df_columns, arrays)))

    @classmethod
    def _mine_common_kwargs(cls, **extra: Any) -> dict:
        return {
            "repositories": ["src-d/go-git"],
            "participants": {},
            "time_from": datetime(2015, 1, 1, tzinfo=timezone.utc),
            "time_to": datetime(2020, 1, 1, tzinfo=timezone.utc),
            "environments": ["production", "staging"],
            "conclusions": [],
            "with_labels": {},
            "without_labels": {},
            "pr_labels": LabelFilter.empty(),
            "jira": JIRAFilter.empty(),
            "release_settings": get_release_match_setting_tag(),
            "logical_settings": LogicalRepositorySettings.empty(),
            "default_branches": get_default_branches(),
            "account": 1,
            "jira_ids": JIRAConfig(1, {}, {}),
            "meta_ids": (6366825,),
            "cache": None,
            **extra,
        }


async def test_reset_broken_deployments_dupe(precomputed_deployments, pdb, rdb):  # noqa: F811
    await gather(
        rdb.execute(
            insert(DeploymentNotification).values(
                account_id=1,
                name="xxx",
                conclusion=DeploymentNotification.CONCLUSION_SUCCESS.decode(),
                environment="production",
                started_at=datetime(2023, 1, 12, tzinfo=timezone.utc),
                finished_at=datetime(2023, 1, 12, 0, 10, tzinfo=timezone.utc),
                created_at=datetime.now(timezone.utc),
                updated_at=datetime.now(timezone.utc),
            ),
        ),
        rdb.execute(
            insert(DeploymentNotification).values(
                account_id=1,
                name="yyy",
                conclusion=DeploymentNotification.CONCLUSION_FAILURE.decode(),
                environment="production",
                started_at=datetime(2023, 1, 11, tzinfo=timezone.utc),
                finished_at=datetime(2023, 1, 11, 0, 10, tzinfo=timezone.utc),
                created_at=datetime.now(timezone.utc),
                updated_at=datetime.now(timezone.utc),
            ),
        ),
        pdb.execute(
            insert(GitHubCommitDeployment).values(
                {
                    GitHubCommitDeployment.acc_id: 1,
                    GitHubCommitDeployment.repository_full_name: "src-d/go-git",
                    GitHubCommitDeployment.commit_id: 2755079,
                    GitHubCommitDeployment.deployment_name: "xxx",
                },
            ),
        ),
        pdb.execute(
            insert(GitHubCommitDeployment).values(
                {
                    GitHubCommitDeployment.acc_id: 1,
                    GitHubCommitDeployment.repository_full_name: "src-d/go-git",
                    GitHubCommitDeployment.commit_id: 2755079,
                    GitHubCommitDeployment.deployment_name: "yyy",
                },
            ),
        ),
    )
    assert await reset_broken_deployments(1, pdb, rdb) == 2
    for name in ("xxx", "Dummy deployment"):
        await assert_missing_row(pdb, GitHubCommitDeployment, deployment_name=name)
    await assert_existing_row(pdb, GitHubCommitDeployment, deployment_name="yyy")


async def test_reset_broken_deployments_wtf(pdb, rdb):
    await pdb.execute(
        insert(GitHubCommitDeployment).values(
            {
                GitHubCommitDeployment.acc_id: 1,
                GitHubCommitDeployment.repository_full_name: "src-d/go-git",
                GitHubCommitDeployment.commit_id: 2755079,
                GitHubCommitDeployment.deployment_name: "xxx",
            },
        ),
    )
    assert await reset_broken_deployments(1, pdb, rdb) == 1


async def test_extract_pr_commits_smoke(dag):
    dag = dag["src-d/go-git"][1]
    pr_commits = extract_pr_commits(
        *dag,
        np.array(
            [
                b"e20d3347d26f0b7193502e2ad7386d7c504b0cde",
                b"6dda959c4bda3a422a9a1c6425f92efa914c4d82",
                b"0000000000000000000000000000000000000000",
            ],
            dtype="S40",
        ),
    )
    assert pr_commits[0].tolist() == [
        b"e20d3347d26f0b7193502e2ad7386d7c504b0cde",
        b"3452c3bde5c0bddfd52bb827d07d4a1e1ed3fb09",
    ]
    assert set(pr_commits[1]) == {
        b"6dda959c4bda3a422a9a1c6425f92efa914c4d82",
        b"9c80677ec0d1778e6d304b235a22f4e636322e74",
        b"129ff16f8686bb74a206cf58000de1d9640e370a",
        b"c8ca7e3d031214b6c0478d62119dfb8a9af1631d",
    }
    assert pr_commits[2].tolist() == []
    assert extract_pr_commits(*dag, np.array([], dtype="S40")).tolist() == []


async def test_extract_pr_commits_fixture():
    with Path(__file__).with_name("extract_pr_commits.pickle").open("rb") as fin:
        args = pickle.load(fin)
    extract_pr_commits(*args)


async def test_extract_independent_ownership_no_stops(dag):
    dag = dag["src-d/go-git"][1]
    stops = np.empty(4, dtype=object)
    stops.fill([])
    ownership = extract_independent_ownership(
        *dag,
        np.array(
            [
                b"b65d94e70ea1d013f43234522fa092168e4f1041",
                b"3713157d189a109bdccdb055200defb17297b6de",
                b"c088fd6a7e1a38e9d5a9815265cb575bb08d08ff",
                b"0000000000000000000000000000000000000000",
            ],
            dtype="S40",
        ),
        stops,
    )
    assert len(ownership[0]) == 443
    assert len(ownership[1]) == 603
    assert len(ownership[2]) == 3
    assert len(ownership[3]) == 0


async def test_extract_independent_ownership_smoke(dag):
    dag = dag["src-d/go-git"][1]
    ownership = extract_independent_ownership(
        *dag,
        np.array(
            [
                b"b65d94e70ea1d013f43234522fa092168e4f1041",
                b"3713157d189a109bdccdb055200defb17297b6de",
                b"c088fd6a7e1a38e9d5a9815265cb575bb08d08ff",
                b"0000000000000000000000000000000000000000",
            ],
            dtype="S40",
        ),
        np.array(
            [
                [b"431af32445562b389397f3ee7af90bf61455fff1"],
                [b"e80cdbabb92a1ec35ffad536f52d3ff04b548fd1"],
                [b"0000000000000000000000000000000000000000"],
                [b"c088fd6a7e1a38e9d5a9815265cb575bb08d08ff"],
            ],
            dtype="S40",
        ),
    )
    assert ownership[3].tolist() == []
    assert set(ownership[2]) == {
        b"c088fd6a7e1a38e9d5a9815265cb575bb08d08ff",
        b"5fddbeb678bd2c36c5e5c891ab8f2b143ced5baf",
        b"5d7303c49ac984a9fec60523f2d5297682e16646",
    }
    assert set(ownership[1]) == {
        b"3713157d189a109bdccdb055200defb17297b6de",
        b"b8b61e74469e0d2662e7d690eee14893f91fe259",
        b"40fa5882a2c73f8c075403b7ec85870f04deda07",
        b"ff18ce3751ad80cfd0297845872ba1d796c36ca5",
        b"5592dabdf9eed67c92b0e411ad375ae763119fd2",
        b"2e092f909f643ef455d84dfa59282f0f0adf3c7a",
        b"9a807f4f29c24bf0dc0b44d7cdfc2233cfd128d3",
    }
    assert set(ownership[0]) == {
        b"b65d94e70ea1d013f43234522fa092168e4f1041",
        b"84b6bd8c22c8683479881a67db03dfdeeeb299ce",
        b"f3554ac62e29fd3e06c6e1fdeda914ac19cb68fa",
        b"77a8f2bfbd2b19d6e19edeb7a9276bc9fe576c00",
        b"62666856d9f4b3150671eb1f215a7072c02c0bc6",
        b"1f39465975d56bbb02f5cdfb1e3e77f41c613f1d",
        b"2b1efd219e1f20d9a0bc380a26074c9d8de2ae1f",
        b"70eff0d7bd1f69856f8028c2487576085a54a42c",
        b"c340fb9a0f1f7c025da5ffa2d1a7389a4eabaae2",
    }
    assert (
        extract_independent_ownership(
            *dag, np.array([], dtype="S40"), np.array([], dtype="S40"),
        ).tolist()
        == []
    )


proper_deployments = {
    "Dummy deployment": Deployment(
        name="Dummy deployment",
        conclusion=DeploymentConclusion.SUCCESS,
        environment="production",
        url=None,
        started_at=np.datetime64(datetime(2019, 11, 1, 12, 0), "us"),
        finished_at=np.datetime64(datetime(2019, 11, 1, 12, 15), "us"),
        components=[
            DeployedComponentStruct(
                repository_full_name="src-d/go-git",
                reference="v4.13.1",
                sha="0d1a009cbb604db18be960db5f1525b99a55d727",
            ),
        ],
        labels=None,
    ),
}


@with_defer
async def test_mine_release_by_name_deployments(
    release_match_setting_tag_or_branch,
    prefixer,
    precomputed_deployments,  # noqa: F811
    mdb,
    pdb,
    rdb,
):
    names = {"36c78b9d1b1eea682703fb1cbb0f4f3144354389", "v4.0.0"}
    releases, _, deps = await mine_releases_by_name(
        {"src-d/go-git": names},
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
    )
    assert deps == proper_deployments
    assert releases.iloc[0][ReleaseFacts.f.deployments] == ["Dummy deployment"]


@with_defer
async def test_mine_releases_deployments(
    release_match_setting_tag_or_branch,
    prefixer,
    precomputed_deployments,  # noqa: F811
    branches,
    default_branches,
    mdb,
    pdb,
    rdb,
):
    releases, _, _, deps = await mine_releases(
        ["src-d/go-git"],
        {},
        branches,
        default_branches,
        datetime(2015, 1, 1, tzinfo=timezone.utc),
        datetime(2020, 1, 1, tzinfo=timezone.utc),
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        with_avatars=False,
        with_extended_pr_details=False,
        with_deployments=True,
    )
    assert deps == proper_deployments
    assert len(releases) == 53
    ndeps = 0
    for rd in releases[ReleaseFacts.f.deployments]:
        ndeps += rd is not None and rd[0] == "Dummy deployment"
    assert ndeps == 51
