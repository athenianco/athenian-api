from datetime import datetime, timezone
from pathlib import Path
import pickle

import numpy as np
import pandas as pd

from athenian.api.defer import with_defer
from athenian.api.internal.miners.filters import JIRAFilter, LabelFilter
from athenian.api.internal.miners.github.dag_accelerated import (
    extract_independent_ownership,
    extract_pr_commits,
)
from athenian.api.internal.miners.github.deployment_accelerated import calc_pr_to_ix_prs
from athenian.api.internal.miners.github.release_mine import mine_releases, mine_releases_by_name
from athenian.api.internal.miners.types import (
    DeployedComponent as DeployedComponentStruct,
    Deployment,
    DeploymentConclusion,
)
from athenian.api.internal.settings import LogicalRepositorySettings


async def test_extract_pr_commits_smoke(dag):
    dag = dag["src-d/go-git"][1]
    pr_commits = extract_pr_commits(
        *dag,
        np.array(
            [
                b"e20d3347d26f0b7193502e2ad7386d7c504b0cde",
                b"6dda959c4bda3a422a9a1c6425f92efa914c4d82",
                b"0000000000000000000000000000000000000000",
            ],
            dtype="S40",
        ),
    )
    assert pr_commits[0].tolist() == [
        b"e20d3347d26f0b7193502e2ad7386d7c504b0cde",
        b"3452c3bde5c0bddfd52bb827d07d4a1e1ed3fb09",
    ]
    assert set(pr_commits[1]) == {
        b"6dda959c4bda3a422a9a1c6425f92efa914c4d82",
        b"9c80677ec0d1778e6d304b235a22f4e636322e74",
        b"129ff16f8686bb74a206cf58000de1d9640e370a",
        b"c8ca7e3d031214b6c0478d62119dfb8a9af1631d",
    }
    assert pr_commits[2].tolist() == []
    assert extract_pr_commits(*dag, np.array([], dtype="S40")).tolist() == []


async def test_extract_pr_commits_fixture():
    with Path(__file__).with_name("extract_pr_commits.pickle").open("rb") as fin:
        args = pickle.load(fin)
    extract_pr_commits(*args)


async def test_extract_independent_ownership_no_stops(dag):
    dag = dag["src-d/go-git"][1]
    stops = np.empty(4, dtype=object)
    stops.fill([])
    ownership = extract_independent_ownership(
        *dag,
        np.array(
            [
                b"b65d94e70ea1d013f43234522fa092168e4f1041",
                b"3713157d189a109bdccdb055200defb17297b6de",
                b"c088fd6a7e1a38e9d5a9815265cb575bb08d08ff",
                b"0000000000000000000000000000000000000000",
            ],
            dtype="S40",
        ),
        stops,
    )
    assert len(ownership[0]) == 443
    assert len(ownership[1]) == 603
    assert len(ownership[2]) == 3
    assert len(ownership[3]) == 0


async def test_extract_independent_ownership_smoke(dag):
    dag = dag["src-d/go-git"][1]
    ownership = extract_independent_ownership(
        *dag,
        np.array(
            [
                b"b65d94e70ea1d013f43234522fa092168e4f1041",
                b"3713157d189a109bdccdb055200defb17297b6de",
                b"c088fd6a7e1a38e9d5a9815265cb575bb08d08ff",
                b"0000000000000000000000000000000000000000",
            ],
            dtype="S40",
        ),
        np.array(
            [
                [b"431af32445562b389397f3ee7af90bf61455fff1"],
                [b"e80cdbabb92a1ec35ffad536f52d3ff04b548fd1"],
                [b"0000000000000000000000000000000000000000"],
                [b"c088fd6a7e1a38e9d5a9815265cb575bb08d08ff"],
            ],
            dtype="S40",
        ),
    )
    assert ownership[3].tolist() == []
    assert set(ownership[2]) == {
        b"c088fd6a7e1a38e9d5a9815265cb575bb08d08ff",
        b"5fddbeb678bd2c36c5e5c891ab8f2b143ced5baf",
        b"5d7303c49ac984a9fec60523f2d5297682e16646",
    }
    assert set(ownership[1]) == {
        b"3713157d189a109bdccdb055200defb17297b6de",
        b"b8b61e74469e0d2662e7d690eee14893f91fe259",
        b"40fa5882a2c73f8c075403b7ec85870f04deda07",
        b"ff18ce3751ad80cfd0297845872ba1d796c36ca5",
        b"5592dabdf9eed67c92b0e411ad375ae763119fd2",
        b"2e092f909f643ef455d84dfa59282f0f0adf3c7a",
        b"9a807f4f29c24bf0dc0b44d7cdfc2233cfd128d3",
    }
    assert set(ownership[0]) == {
        b"b65d94e70ea1d013f43234522fa092168e4f1041",
        b"84b6bd8c22c8683479881a67db03dfdeeeb299ce",
        b"f3554ac62e29fd3e06c6e1fdeda914ac19cb68fa",
        b"77a8f2bfbd2b19d6e19edeb7a9276bc9fe576c00",
        b"62666856d9f4b3150671eb1f215a7072c02c0bc6",
        b"1f39465975d56bbb02f5cdfb1e3e77f41c613f1d",
        b"2b1efd219e1f20d9a0bc380a26074c9d8de2ae1f",
        b"70eff0d7bd1f69856f8028c2487576085a54a42c",
        b"c340fb9a0f1f7c025da5ffa2d1a7389a4eabaae2",
    }
    assert (
        extract_independent_ownership(
            *dag, np.array([], dtype="S40"), np.array([], dtype="S40"),
        ).tolist()
        == []
    )


proper_deployments = {
    "Dummy deployment": Deployment(
        name="Dummy deployment",
        conclusion=DeploymentConclusion.SUCCESS,
        environment="production",
        url=None,
        started_at=pd.Timestamp(datetime(2019, 11, 1, 12, 0, tzinfo=timezone.utc)),
        finished_at=pd.Timestamp(datetime(2019, 11, 1, 12, 15, tzinfo=timezone.utc)),
        components=[
            DeployedComponentStruct(
                repository_full_name="src-d/go-git",
                reference="v4.13.1",
                sha="0d1a009cbb604db18be960db5f1525b99a55d727",
            ),
        ],
        labels=None,
    ),
}


@with_defer
async def test_mine_release_by_name_deployments(
    release_match_setting_tag_or_branch,
    prefixer,
    precomputed_deployments,
    mdb,
    pdb,
    rdb,
):
    names = {"36c78b9d1b1eea682703fb1cbb0f4f3144354389", "v4.0.0"}
    releases, _, deps = await mine_releases_by_name(
        {"src-d/go-git": names},
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
    )
    assert deps == proper_deployments
    assert releases[0][1].deployments == ["Dummy deployment"]


@with_defer
async def test_mine_releases_deployments(
    release_match_setting_tag_or_branch,
    prefixer,
    precomputed_deployments,
    branches,
    default_branches,
    mdb,
    pdb,
    rdb,
):
    releases, _, _, deps = await mine_releases(
        ["src-d/go-git"],
        {},
        branches,
        default_branches,
        datetime(2015, 1, 1, tzinfo=timezone.utc),
        datetime(2020, 1, 1, tzinfo=timezone.utc),
        LabelFilter.empty(),
        JIRAFilter.empty(),
        release_match_setting_tag_or_branch,
        LogicalRepositorySettings.empty(),
        prefixer,
        1,
        (6366825,),
        mdb,
        pdb,
        rdb,
        None,
        with_avatars=False,
        with_pr_titles=False,
        with_deployments=True,
    )
    assert deps == proper_deployments
    assert len(releases) == 53
    ndeps = 0
    for _, f in releases:
        ndeps += f.deployments is not None and f.deployments[0] == "Dummy deployment"
    assert ndeps == 51


def test_calc_pr_to_ix_prs_smoke():
    array = np.array
    int32 = np.int32
    prs_offsets = array(
        [
            array([3, 3, 3], dtype=int32),
            array([3, 3, 3], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([3, 3, 3], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([2, 2, 2], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 7], dtype=int32),
            array([], dtype=int32),
            array([1, 1, 1], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([2, 2, 2], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([5, 5, 5], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 0], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 4], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([2, 2, 2], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 4], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([1, 1, 1], dtype=int32),
            array([], dtype=int32),
            array([10, 10, 10], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 3], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([3, 3, 3], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 3], dtype=int32),
            array([], dtype=int32),
            array([3, 3, 3], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([2, 2, 2], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 6], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([3, 3, 3], dtype=int32),
            array([0, 0, 5], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([9, 9, 9], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([1, 1, 1], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 4], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([2, 2, 2], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([1, 1, 1], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([1, 1, 1], dtype=int32),
            array([], dtype=int32),
            array([2, 2, 2], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([4, 4, 4], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 10], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([10, 10, 10], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([4, 4, 4], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([2, 2, 2], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([2, 2, 2], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 12], dtype=int32),
            array([3, 3, 3], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([1, 1, 1], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([2, 2, 2], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([4, 4, 4], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([10, 10, 10], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([1, 1, 1], dtype=int32),
            array([], dtype=int32),
            array([0, 0, 0], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([5, 5, 5], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([4, 4, 4], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([11, 11, 11], dtype=int32),
            array([11, 11, 11], dtype=int32),
            array([0, 0, 13], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([6, 6, 6], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([1, 1, 1], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([9, 9, 9], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
            array([], dtype=int32),
        ],
        dtype=object,
    )
    prs = array(
        [
            array(
                [40338004, 40338577, 40339865, 40317429, 40339416, 40331815, 40339579, 40337542],
            ),
            array([40339865, 40338577, 40338004]),
            array([40339865]),
            array([40339579, 40337542]),
            array([40331815, 40317429, 40339416]),
            array([40338283, 40336674, 40336177]),
            array([40338283, 40336674, 40336177]),
            array([40338036, 40333629, 40338418]),
            array([40338283, 40336674, 40336177]),
            array([40338577, 40338004]),
            array([40338283, 40336674, 40336177]),
            array([40334046, 40333396]),
            array([40338418]),
            array([40338283]),
            array([40338036]),
            array([40337420]),
            array([40333629]),
            array([40335220]),
            array([40336607, 40335875]),
            array([40336607, 40335875]),
            array([40336803]),
            array([40336674]),
            array([40336177]),
            array([40335875]),
            array([40335799]),
            array([40331914, 40331159, 40334774, 40333515, 40332810, 40333118, 40333328]),
            array([40333118]),
            array([40335421]),
            array([40335421]),
            array([40334774]),
            array([40334046]),
            array([40333939, 40334306]),
            array([40334306]),
            array([40333515]),
            array([40333939]),
            array([40333822, 40331662, 40333147, 40332460, 40332018]),
            array([40333822]),
            array([40333328]),
            array([40333549, 40308236, 40305722, 40307015]),
            array([40333549]),
            array([40333396]),
            array([40333147]),
            array([40332810]),
            array([40331914]),
            array([40332460]),
            array([40331159]),
            array([40328398, 40332295, 40330500, 40329776]),
            array([40332295]),
            array([40330500]),
            array([40332018]),
            array([40331662]),
            array([40329776]),
            array([40330137, 40330024]),
            array([40328398]),
            array([40330024]),
            array([40330137]),
            array([40323765, 40329401, 40322666]),
            array([40322666]),
            array([40326855, 40329586, 40327928, 40328864]),
            array([40327928]),
            array([40329401]),
            array([40329586]),
            array([40328864]),
            array([40329361]),
            array([40329361]),
            array(
                [
                    40327036,
                    40327121,
                    40326970,
                    40326935,
                    40327001,
                    40326209,
                    40327029,
                    40326880,
                    40327975,
                    40327094,
                ],
            ),
            array([40327121, 40327094, 40327001, 40327975]),
            array([40326855]),
            array([40326466, 40325099, 40326030]),
            array([40327029, 40327036, 40326880, 40326935, 40326970]),
            array([40320321, 40311336, 40291907]),
            array([40326030]),
            array([40325099, 40326466]),
            array([40326209]),
            array([40325212, 40325135, 40324874]),
            array([40325212, 40325135]),
            array([40324874]),
            array([40322183, 40324604, 40323747]),
            array([40324604]),
            array([40323250, 40323698, 40323367]),
            array([40322183]),
            array([40324467]),
            array([40323747]),
            array([40323765]),
            array([40323698]),
            array([40321166, 40322936]),
            array([40323367]),
            array([40323250]),
            array([40322936]),
            array([40321166]),
            array([40320654, 40319209, 40321038, 40321094, 40321812, 40319794]),
            array([40321094]),
            array([40321038]),
            array([40321812]),
            array([40319794]),
            array([40321296]),
            array([40320654]),
            array([40320321]),
            array([40291907]),
            array([40319209]),
            array([40318309, 40317207, 40318723]),
            array([40315103, 40314155, 40314668, 40315386, 40316692]),
            array([40315386]),
            array([40318723]),
            array([40311336]),
            array([40316692]),
            array([40318309]),
            array([40317207]),
            array(
                [
                    40315794,
                    40315891,
                    40315718,
                    40315734,
                    40315635,
                    40317176,
                    40315685,
                    40315805,
                    40315714,
                ],
            ),
            array([40317176]),
            array(
                [40315805, 40315734, 40315891, 40315635, 40315685, 40315714, 40315794, 40315718],
            ),
            array(
                [
                    40293894,
                    40303148,
                    40288197,
                    40261476,
                    40297183,
                    40309025,
                    40262866,
                    40283789,
                    40279760,
                    40287845,
                ],
            ),
            array([40314155]),
            array([40315103]),
            array([40314668]),
            array([40314563]),
            array([40314563]),
            array([40312126, 40309480, 40311177, 40314362]),
            array([40314362]),
            array([40311177]),
            array([40313042, 40313461]),
            array([40313461]),
            array([40313042]),
            array([40310436]),
            array([40312796]),
            array([40312126]),
            array([40310436]),
            array([40312474]),
            array([40312161]),
            array([40312161]),
            array([40311581, 40311785]),
            array([40311785]),
            array([40311581]),
            array([40309480]),
            array([40310400]),
            array([40310023, 40306418, 40306446, 40305597]),
            array([40310023]),
            array([40309515]),
            array([40297183, 40303148, 40309025, 40293894, 40309149, 40287845]),
            array([40309025]),
            array([40309025]),
            array(
                [
                    40306164,
                    40306748,
                    40303512,
                    40305305,
                    40306196,
                    40303723,
                    40294350,
                    40306930,
                    40304986,
                    40302577,
                ],
            ),
            array([40306446, 40305597, 40306418]),
            array([40306196]),
            array(
                [
                    40307179,
                    40305809,
                    40306292,
                    40306386,
                    40306357,
                    40306474,
                    40305396,
                    40306516,
                    40307149,
                    40306333,
                ],
            ),
            array([40306516, 40306357, 40306333, 40307149]),
            array([40308236]),
            array([40307179, 40306474, 40306386, 40306292]),
            array([40303512]),
            array([40307015, 40305722]),
            array([40306930]),
            array([40306748]),
            array([40306164]),
            array([40305809]),
            array([40305809]),
            array([40305305]),
            array([40305396]),
            array([40304986]),
            array([40302951, 40301229, 40302020, 40303571]),
            array([40302951]),
            array([40303571, 40302020, 40301229]),
            array([40303723]),
            array([40304317]),
            array([40302418, 40304118]),
            array([40304118]),
            array([40302577]),
            array([40302418]),
            array([40294350]),
            array([40303148]),
            array([40302620, 40300860]),
            array([40302620]),
            array([40300860]),
            array(
                [
                    40298984,
                    40286969,
                    40298486,
                    40300005,
                    40299460,
                    40300989,
                    40294810,
                    40298571,
                    40293614,
                    40299099,
                    40296617,
                    40296293,
                ],
            ),
            array([40300670, 40300823, 40300571]),
            array([40300823]),
            array([40299460]),
            array([40300989]),
            array([40300005, 40298984, 40299099]),
            array([40300670]),
            array([40300571]),
            array([40300048]),
            array([40297183]),
            array([40300048]),
            array([40299686, 40299760]),
            array([40299760]),
            array([40299686]),
            array([40299488, 40299203, 40296554, 40298860]),
            array([40299488, 40296554]),
            array([40298860, 40299203]),
            array([40298571]),
            array([40298486]),
            array(
                [
                    40296443,
                    40296005,
                    40295957,
                    40298128,
                    40296964,
                    40296064,
                    40294992,
                    40297416,
                    40295960,
                    40297074,
                ],
            ),
            array([40296617]),
            array([40296293]),
            array([40298128]),
            array([40297416]),
            array([40296005, 40297074, 40296064]),
            array([40296964]),
            array([40295957, 40296443, 40294992, 40295960]),
            array([40294810]),
            array([40292102]),
            array([40295703]),
            array([40294124, 40294484]),
            array([40286969]),
            array([40292102]),
            array([40294124, 40294484]),
            array([40293614]),
            array([40293894]),
            array(
                [40293054, 40291733, 40292662, 40291830, 40293126, 40288600, 40286408, 40291418],
            ),
            array([40293240]),
            array([40293054, 40293126]),
            array([40291733]),
            array([40292662]),
            array([40291830]),
            array([40287845]),
            array([40291236, 40290428, 40291527, 40291074]),
            array([40291527]),
            array([40291418]),
            array([40291236]),
            array([40290428, 40291074]),
            array(
                [
                    40287265,
                    40287791,
                    40289439,
                    40287613,
                    40287434,
                    40287589,
                    40287474,
                    40287469,
                    40287500,
                    40287411,
                    40287465,
                    40287917,
                ],
            ),
            array(
                [
                    40287791,
                    40287474,
                    40287465,
                    40287265,
                    40287469,
                    40287589,
                    40287613,
                    40287411,
                    40287434,
                    40287500,
                    40289439,
                ],
            ),
            array(
                [
                    40278540,
                    40281871,
                    40278733,
                    40284498,
                    40278134,
                    40284614,
                    40290172,
                    40283945,
                    40281815,
                    40286803,
                    40282497,
                    40283741,
                    40281299,
                ],
            ),
            array([40290172]),
            array([40287791]),
            array([40287474, 40287465, 40289439]),
            array([40289494, 40288197]),
            array([40288197]),
            array([40287411, 40287265, 40287500, 40287613, 40287434, 40287589, 40287469]),
            array([40288600, 40286408]),
            array([40287917]),
            array([40286803]),
            array(
                [
                    40286057,
                    40283870,
                    40286136,
                    40284072,
                    40277978,
                    40283251,
                    40282905,
                    40280014,
                    40277718,
                    40261705,
                    40285995,
                    40262189,
                    40267980,
                    40284751,
                    40274748,
                ],
            ),
            array([40286057]),
            array([40283870, 40284072, 40286136, 40277978]),
            array([40285995]),
            array([40283870]),
            array([40262866, 40261476, 40285202, 40258619, 40258191, 40283789, 40279760]),
            array([40277718, 40274748, 40284751, 40267980, 40262189, 40282905, 40280014]),
            array([40284614]),
            array([40284498]),
            array([40283945]),
            array([40283741]),
            array([40283789]),
            array([40282497]),
            array([40283251]),
            array([40281731]),
            array([40281815]),
            array([40281871]),
            array([40281731]),
            array(
                [
                    40278919,
                    40278225,
                    40278222,
                    40278316,
                    40278289,
                    40277422,
                    40278084,
                    40278171,
                    40278194,
                ],
            ),
            array([40278919]),
            array([40278733]),
            array([40281299]),
        ],
        dtype=object,
    )
    jira_col, pr_to_ix = calc_pr_to_ix_prs(prs, prs_offsets)
    assert type(pr_to_ix).__name__ == "PyCapsule"
    assert isinstance(jira_col, np.ndarray)
    assert len(jira_col) == len(prs)
    assert jira_col.dtype == object
